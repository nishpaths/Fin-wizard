<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Financial Needs Analysis Wizard</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #000000;
        color: #ffffff;
        margin: 0;
        padding: 0;
      }

      .wizard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        padding: 20px;
        background-color: #1a1a1a;
        border-bottom: 2px solid #bdb76b;
      }

      .header h1 {
        margin: 0;
        font-size: 2em;
      }

      .header p {
        margin: 10px 0;
        font-size: 1.1em;
      }

      .wizard-tabs {
        display: flex;
        justify-content: space-around;
        background-color: #bdb76b;
        padding: 10px 0;
        border-radius: 8px 8px 0 0;
      }

      .wizard-tabs a {
        color: #000000;
        text-decoration: none;
        padding: 10px 20px;
        font-weight: bold;
      }

      .wizard-tabs a.active {
        background-color: #a9a357;
        border-radius: 4px;
      }

      .wizard-tabs a:hover {
        background-color: #a9a357;
        border-radius: 4px;
      }

      .step {
        display: none;
        padding: 20px;
        background: #000000;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 0 10px rgba(189, 183, 107, 0.3);
      }

      .step.active {
        display: block;
      }

      .sub-step {
        display: none !important;
      }

      .sub-step.active {
        display: block !important;
      }

      h2 {
        color: #bdb76b;
        margin-bottom: 15px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #bdb76b;
      }

      th {
        background-color: #bdb76b;
        color: #000000;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdb76b;
        border-radius: 4px;
        background-color: #000000;
        color: #ffffff;
      }

      input[type="text"]::placeholder,
      input[type="number"]::placeholder {
        color: #cccccc;
      }

      .projected-value,
      .future-value,
      .total-value {
        font-weight: bold;
        color: #bdb76b;
      }

      .buttons {
        text-align: center;
        margin-top: 20px;
      }

      button {
        padding: 10px 20px;
        background-color: #bdb76b;
        color: #000000;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        margin: 0 10px;
      }

      button:hover {
        background-color: #a9a357;
      }

      #resultsPage {
        padding: 20px;
      }

      #resultsPage h2 {
        text-align: center;
      }

      #assetResults,
      #goalResults {
        margin-bottom: 20px;
      }

      .spouse-section,
      .dependents-section {
        margin-top: 20px;
      }

      .calculated-age {
        color: #bdb76b;
        font-weight: bold;
      }

      .error-message {
        color: #ff5555;
        font-size: 0.9em;
        text-align: center;
        margin-bottom: 10px;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
      }

      .modal-content {
        background-color: #000000;
        margin: 5% auto;
        padding: 20px;
        border: 2px solid #bdb76b;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .close {
        color: #bdb76b;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: #a9a357;
      }

      .ssa-tables {
        margin-top: 20px;
      }

      .ssa-info-table {
        width: 100%;
        margin: 15px 0;
        border-collapse: collapse;
      }

      .ssa-info-table th,
      .ssa-info-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid #bdb76b;
      }

      .ssa-info-table th {
        background-color: #bdb76b;
        color: #000000;
      }

      .modal h2,
      .modal h3 {
        color: #bdb76b;
        text-align: center;
        margin-bottom: 15px;
      }

      .spouse-column {
        display: none;
      }

      body[data-marital-status="Married"] .spouse-column {
        display: table-cell;
      }

      #personalOverview {
        margin-bottom: 20px;
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #bdb76b;
        font-size: 0.9em;
      }

      #personalOverview h3 {
        margin: 0 0 10px 0;
        font-size: 1.1em;
      }

      #personalOverview table {
        width: 100%;
        border-collapse: collapse;
      }

      #personalOverview td {
        padding: 4px 8px;
        border: none;
        line-height: 1.2;
      }

      #personalOverview strong {
        color: #bdb76b;
      }

      #personalOverview table table {
        margin: 5px 0;
        background: rgba(189, 183, 107, 0.1);
        border-radius: 4px;
      }

      #spouseInfoSection,
      #dependentsInfoSection {
        border-top: 1px solid rgba(189, 183, 107, 0.3);
        margin-top: 5px;
        padding-top: 5px;
      }

      #personalOverview table table td {
        padding: 2px 8px;
      }

      #cashFlowTable {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      #cashFlowTable th,
      #cashFlowTable td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #bdb76b;
      }

      #cashFlowTable th {
        background-color: #bdb76b;
        color: #000000;
      }

      #cashFlowTable input {
        width: 100%;
        padding: 8px;
        border: 1px solid #bdb76b;
        border-radius: 4px;
        background-color: #000000;
        color: #ffffff;
        box-sizing: border-box;
      }

      #cashFlowTable input::placeholder {
        color: #cccccc;
      }

      #cashFlowTable .projected-value {
        font-weight: bold;
        color: #bdb76b;
      }

      #step2 h2 {
        color: #bdb76b;
        margin-bottom: 15px;
        font-size: 1.5em;
      }

      #step2 h3 {
        color: #bdb76b;
        margin-bottom: 15px;
        font-size: 1.2em;
      }

      #step2 .sub-step {
        padding: 20px;
        background: #000000;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 0 10px rgba(189, 183, 107, 0.3);
      }

      .debt-overview {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #bdb76b;
        font-size: 0.9em;
        margin-bottom: 20px;
      }

      .debt-overview h3 {
        margin: 0 0 10px 0;
        font-size: 1.1em;
      }

      .debt-overview table {
        width: 100%;
        border-collapse: collapse;
      }

      .debt-overview td {
        padding: 4px 8px;
        border: none;
        line-height: 1.2;
      }

      .debt-overview .priority-high {
        color: #ff5555;
      }

      .debt-overview .priority-medium {
        color: #ffd700;
      }

      .debt-overview .priority-low {
        color: #4caf50;
      }
    </style>
    <!-- html2pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div class="wizard-container">
      <!-- Header -->
      <div class="header">
        <h1>Financial Needs Analysis Wizard</h1>
        <p>
          Strategic Diversification based on Suitability, Affordability, and
          Long-Term Planning
        </p>
      </div>
      <!-- Wizard Tabs -->
      <div class="wizard-tabs">
        <a class="active" href="#" onclick="navigateToStep(1); return false;"
          >Personal Details</a
        >
        <a href="#" onclick="navigateToStep(2); return false;">Cash Flow</a>
        <a href="#" onclick="navigateToStep(3); return false;">Debt</a>
        <a href="#" onclick="navigateToStep(4); return false;">Assets</a>
        <a href="#" onclick="navigateToStep(5); return false;">Goals</a>
        <a href="#" onclick="calculateAndShowResults(); return false;"
          >Results</a
        >
      </div>
      <!-- Step 1: Personal Info -->
      <div class="step" id="step1">
        <h2>Step 1: Tell Us About Yourself</h2>
        <table id="personalInfoTable">
          <tr>
            <th>Field</th>
            <th>User</th>
          </tr>
          <tr>
            <td>Name</td>
            <td>
              <input id="userName" placeholder="Enter your name" type="text" />
            </td>
          </tr>
          <tr>
            <td>Date of Birth (mm/yyyy)</td>
            <td>
              <input
                id="userDOB"
                oninput="calculateAge('user')"
                placeholder="mm/yyyy"
                type="text"
              />
            </td>
          </tr>
          <tr>
            <td>Current Age</td>
            <td><span class="calculated-age" id="userAge">0</span></td>
          </tr>
          <tr>
            <td>Retirement Age</td>
            <td>
              <input
                id="userRetirementAge"
                min="0"
                oninput="updateAllProjectedValues()"
                placeholder="Enter retirement age"
                step="1"
                type="number"
                value="65"
              />
            </td>
          </tr>
          <tr>
            <td>Marital Status</td>
            <td>
              <select id="maritalStatus" onchange="toggleSpouseSection()">
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Immigration Status</td>
            <td>
              <select id="userImmigrationStatus">
                <option value="Citizen">Citizen</option>
                <option value="GC">Green Card (GC)</option>
                <option value="Immigrant Visa">Immigrant Visa</option>
                <option value="EAD">EAD</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Employment Status</td>
            <td>
              <select id="userEmploymentStatus">
                <option value="Employee">Employee</option>
                <option value="Business/Self-Employment">
                  Business/Self-Employment
                </option>
                <option value="Unemployed">Unemployed</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Email</td>
            <td>
              <input id="email" placeholder="example@email.com" type="text" />
            </td>
          </tr>
          <tr>
            <td>City &amp; State</td>
            <td>
              <input id="cityState" placeholder="Seattle, WA" type="text" />
            </td>
          </tr>
          <tr>
            <td>Number of Dependents</td>
            <td>
              <input
                id="dependents"
                min="0"
                oninput="updateDependentsSection()"
                placeholder="Enter number of dependents"
                step="1"
                type="number"
              />
            </td>
          </tr>
        </table>
        <!-- Will & Trust Section -->
        <div class="will-trust-section">
          <h3>Will &amp; Trust Information</h3>
          <table>
            <tr>
              <td>Do you have Will &amp; Trust?</td>
              <td>
                <select
                  id="willTrustStatus"
                  onchange="toggleWillTrustFunding()"
                >
                  <option value="NO">NO</option>
                  <option value="YES">YES</option>
                </select>
              </td>
            </tr>
            <tr id="willTrustFundingRow" style="display: none">
              <td>Funding Status</td>
              <td>
                <select id="willTrustFunding">
                  <option value="Funded">Funded</option>
                  <option value="Not Funded">Not Funded</option>
                </select>
              </td>
            </tr>
          </table>
        </div>
        <!-- Spouse Section (Hidden by Default) -->
        <div class="spouse-section" id="spouseSection" style="display: none">
          <h3>Spouse Information</h3>
          <table>
            <tr>
              <th>Field</th>
              <th>Spouse</th>
            </tr>
            <tr>
              <td>Name</td>
              <td>
                <input
                  id="spouseName"
                  placeholder="Enter spouse's name"
                  type="text"
                />
              </td>
            </tr>
            <tr>
              <td>Date of Birth (mm/yyyy)</td>
              <td>
                <input
                  id="spouseDOB"
                  oninput="calculateAge('spouse')"
                  placeholder="mm/yyyy"
                  type="text"
                />
              </td>
            </tr>
            <tr>
              <td>Current Age</td>
              <td><span class="calculated-age" id="spouseAge">0</span></td>
            </tr>
          </table>
        </div>
        <!-- Dependents Section (Dynamically Generated) -->
        <div class="dependents-section" id="dependentsSection"></div>
        <div class="buttons">
          <button onclick="nextStep(2)">Next</button>
        </div>
      </div>
      <!-- Step 2: Cash Flow -->
      <div class="step" id="step2">
        <h2>Step 2: Cash Flow Analysis</h2>
        <!-- Sub-Step 2.1: Monthly Income & Expenses -->
        <div class="sub-step active" id="subStep2-1">
          <table id="cashFlowTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>Inflation Rate (%)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Monthly Income (Wages)</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="monthly-income"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="monthly-income"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="inflation-rate"
                    data-metric="monthly-income"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="monthly-income"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Monthly Income - Business</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="monthly-business"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="monthly-business"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="inflation-rate"
                    data-metric="monthly-business"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="monthly-business"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Monthly Income - Rental</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="monthly-rental"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="monthly-rental"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="inflation-rate"
                    data-metric="monthly-rental"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="monthly-rental"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Monthly Expenses w/o Mortgage</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="monthly-expenses"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="monthly-expenses"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="0"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="inflation-rate"
                    data-metric="monthly-expenses"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    placeholder="3"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="monthly-expenses"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Monthly Mortgage Expense</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="monthly-mortgage"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="monthly-mortgage"
                    min="0"
                    oninput="updateCashFlowProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>-</td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevStep(1)">Previous</button>
            <button onclick="nextStep(3)">Next</button>
          </div>
        </div>
      </div>
      <!-- Step 3: Debt -->
      <div class="step" id="step3">
        <h2>Step 3: Your Debt</h2>
        <!-- Sub-Step 3.1: Debt Analysis -->
        <div class="sub-step" id="subStep3-1">
          <h3>Step 3.1: Debt Analysis</h3>
          <table id="debtAnalysisTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Amount ($)</th>
                <th>Monthly Payment ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Mortgage Debt (Sum)</td>
                <td>
                  <input
                    class="debt-amount"
                    data-metric="mortgage-debt"
                    min="0"
                    oninput="updateDebtAmount(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="monthly-payment"
                    data-metric="mortgage-payment"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Credit Card Debt</td>
                <td>
                  <input
                    class="debt-amount"
                    data-metric="credit-card-debt"
                    min="0"
                    oninput="updateDebtAmount(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="monthly-payment"
                    data-metric="credit-card-payment"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Car Loan Debt</td>
                <td>
                  <input
                    class="debt-amount"
                    data-metric="car-loan-debt"
                    min="0"
                    oninput="updateDebtAmount(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="monthly-payment"
                    data-metric="car-loan-payment"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Student Loan Debt</td>
                <td>
                  <input
                    class="debt-amount"
                    data-metric="student-loan-debt"
                    min="0"
                    oninput="updateDebtAmount(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="monthly-payment"
                    data-metric="student-loan-payment"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Any other Debt (Sum)</td>
                <td>
                  <input
                    class="debt-amount"
                    data-metric="other-debt"
                    min="0"
                    oninput="updateDebtAmount(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="monthly-payment"
                    data-metric="other-debt-payment"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevStep(2)">Previous</button>
            <button onclick="nextStep(4)">Next</button>
          </div>
        </div>
        <!-- Add this inside the debt step, after the debtAnalysisTable -->
        <div class="debt-overview">
          <h3>Debt Overview &amp; Recommendations</h3>
          <table>
            <tr>
              <td><strong>Total Debt:</strong></td>
              <td>
                <span class="total-value" id="totalDebtAmount">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Total Monthly Payments:</strong></td>
              <td>
                <span class="total-value" id="totalMonthlyPayment">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Priority Focus:</strong></td>
              <td><span id="debtPriorityFocus">-</span></td>
            </tr>
            <tr>
              <td colspan="2">
                <div id="debtRecommendations"></div>
              </td>
            </tr>
          </table>
        </div>
      </div>
      <!-- Step 4: Assets -->
      <div class="step" id="step4">
        <h2>Step 4: Assets</h2>
        <!-- Sub-Step 4.1: College Fund Savings -->
        <div class="sub-step" id="subStep4-1">
          <h3>Step 4.1: College Fund Savings</h3>
          <table id="collegeFundTable">
            <thead>
              <tr>
                <th>Child Name</th>
                <th>Years Until College</th>
                <th>Present Value ($)</th>
                <th>Annual Contribution ($)</th>
                <th>Rate of Return (%)</th>
                <th>Projected Value ($)</th>
              </tr>
            </thead>
            <tbody id="collegePlanningBody">
              <!-- Rows will be inserted dynamically -->
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevStep(3)">Previous</button>
            <button onclick="nextSubStep(2, 4)">Next</button>
          </div>
          <script>
            function renderCollegePlanningRows() {
              const count =
                parseInt(document.getElementById("dependents").value) || 0;
              const tbody = document.getElementById("collegePlanningBody");
              if (!tbody) return;

              tbody.innerHTML = "";

              for (let i = 1; i <= count; i++) {
                const name =
                  document.getElementById(`dependentName${i}`)?.value ||
                  `Child ${i}`;
                const yearsUntilCollege = calculateYearsUntilCollege(i);

                const tr = document.createElement("tr");
                tr.setAttribute("data-child", i);
                tr.innerHTML = `
                  <td>${name}</td>
                  <td style="text-align: center;">${yearsUntilCollege}</td>
                  <td>
                    <input type="number" 
                           class="present-value" 
                           data-metric="529-child${i}" 
                           data-child="${i}" 
                           min="0" 
                           step="0.01" 
                           oninput="updateCollegeProjectedValue(this)">
                  </td>
                  <td>
                    <input type="number" 
                           class="annual-contribution" 
                           data-metric="529-child${i}" 
                           data-child="${i}" 
                           min="0" 
                           step="0.01" 
                           oninput="updateCollegeProjectedValue(this)">
                  </td>
                  <td>
                    <input type="number" 
                           class="rate-of-return" 
                           data-metric="529-child${i}" 
                           data-child="${i}" 
                           min="0" 
                           max="100"
                           step="0.1" 
                           placeholder="4.0"
                           oninput="updateCollegeProjectedValue(this)">
                  </td>
                  <td>
                    <span class="projected-value" 
                          data-metric="529-child${i}" 
                          data-child="${i}">0.00</span>
                  </td>
                `;
                tbody.appendChild(tr);
              }
            }

            function calculateYearsUntilCollege(childIndex) {
              const dobInput = document.getElementById(
                `dependentDOB${childIndex}`
              )?.value;
              if (!dobInput) return 18;

              const [month, year] = dobInput.split("/").map(Number);
              if (!month || !year || month < 1 || month > 12) return 18;

              const currentDate = new Date(2025, 2, 26); // March 26, 2025
              const birthDate = new Date(year, month - 1);
              let age = currentDate.getFullYear() - birthDate.getFullYear();

              if (
                currentDate.getMonth() < birthDate.getMonth() ||
                (currentDate.getMonth() === birthDate.getMonth() &&
                  currentDate.getDate() < birthDate.getDate())
              ) {
                age--;
              }

              return Math.max(0, 18 - age);
            }

            function updateCollegeProjectedValue(childIndex) {
              const metric = `529-child${childIndex}`;
              const presentValue =
                parseFloat(
                  document.querySelector(
                    `.present-value[data-metric="${metric}"]`
                  )?.value
                ) || 0;
              const annualContribution =
                parseFloat(
                  document.querySelector(
                    `.annual-contribution[data-metric="${metric}"]`
                  )?.value
                ) || 0;
              const rateOfReturn =
                parseFloat(
                  document.querySelector(
                    `.rate-of-return[data-metric="${metric}"]`
                  )?.value
                ) || 4;
              const yearsUntilCollege = calculateYearsUntilCollege(childIndex);

              const rate = rateOfReturn / 100;
              const projectedValue = calculateProjectedCollegeValue(
                presentValue,
                annualContribution,
                rate,
                yearsUntilCollege
              );

              const projectedSpan = document.querySelector(
                `.projected-value[data-metric="${metric}"]`
              );
              if (projectedSpan) {
                projectedSpan.textContent = projectedValue.toFixed(2);
              }
            }

            function calculateProjectedCollegeValue(
              presentValue,
              annualContribution,
              rate,
              years
            ) {
              if (years <= 0) return presentValue;
              if (rate <= 0) return presentValue + annualContribution * years;

              const futureValuePrincipal =
                presentValue * Math.pow(1 + rate, years);
              const futureValueContributions =
                (annualContribution * (Math.pow(1 + rate, years) - 1)) / rate;
              return futureValuePrincipal + futureValueContributions;
            }

            // Event Listeners
            document.addEventListener("DOMContentLoaded", function () {
              // Initial render
              renderCollegePlanningRows();

              // Listen for changes in dependents
              document
                .getElementById("dependents")
                ?.addEventListener("input", renderCollegePlanningRows);

              // Listen for changes in DOB
              document.addEventListener("input", function (e) {
                if (e.target.id?.startsWith("dependentDOB")) {
                  renderCollegePlanningRows();
                }
              });
            });
          </script>
        </div>
        <!-- Sub-Step 4.2: Family Protection & Insurance -->
        <div class="sub-step" id="subStep4-2">
          <h3>Step 4.2: Family Protection &amp; Insurance</h3>
          <table id="familyProtectionTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>Rate of Return (%)</th>
                <th>Purpose</th>
                <th>User Annual Contribution ($)</th>
                <th class="spouse-column">Spouse Annual Contribution ($)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Life Insurance at Work</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="lifeWork"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="lifeWork"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>-</td>
                <td class="spouse-column">-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Life Insurance Outside Work</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="lifeOutside"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="lifeOutside"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>-</td>
                <td class="spouse-column">-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Cash Value Life Insurance</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="cashValue"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="cashValue"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="cashValue"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    placeholder="6.65"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <select
                    class="purpose"
                    data-metric="cashValue"
                    onchange="updateFinancialDataStore(this)"
                  >
                    <option value="">Select Purpose</option>
                    <option value="emergency">Emergency Fund</option>
                    <option value="college">College Fund</option>
                    <option value="retirement">Retirement Payout</option>
                    <option value="longterm">Long Term care</option>
                    <option value="legacy">Legacy overview</option>
                  </select>
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="cashValue"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="cashValue"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <span class="future-value" data-metric="cashValue">0.00</span>
                </td>
              </tr>
              <tr>
                <td>Disability Insurance</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="disability"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="disability"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>-</td>
                <td class="spouse-column">-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>Long Term Care Insurance</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="longTermCare"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="longTermCare"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>-</td>
                <td class="spouse-column">-</td>
                <td>-</td>
              </tr>
              <tr>
                <td>HSA</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="hsa"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="hsa"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="hsa"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    placeholder="4"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>-</td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="hsa"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="hsa"
                    min="0"
                    oninput="updateProjectedValue(this, 'future')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <span class="future-value" data-metric="hsa">0.00</span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(1, 4)">Previous</button>
            <button onclick="nextSubStep(3, 4)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 4.3: Retirement Planning -->
        <div class="sub-step" id="subStep4-3">
          <h3>Step 4.3: Retirement Planning</h3>
          <p id="retirementAgeMessage"></p>
          <script>
            // Modal functions
            function openSSAModal(event) {
              event.preventDefault();
              document.getElementById("ssaModal").style.display = "block";
            }

            function closeSSAModal() {
              document.getElementById("ssaModal").style.display = "none";
            }

            // Close modal when clicking outside of it
            window.onclick = function (event) {
              const modal = document.getElementById("ssaModal");
              if (event.target === modal) {
                modal.style.display = "none";
              }
            };

            function updateRetirementAgeMessage() {
              const userRetirementAge = parseInt(
                document.getElementById("userRetirementAge")?.value || "65"
              );
              const userAge = parseInt(
                document.getElementById("userAge")?.textContent || "0"
              );
              const yearsLeft = userRetirementAge - userAge;

              let message =
                `Your retirement age is ${userRetirementAge}, remaining years till retirement: ${
                  yearsLeft >= 0 ? yearsLeft : 0
                }` +
                " " +
                "(" +
                "add up spouse's retirement values in present and annual contributions " +
                ")";

              const msgEl = document.getElementById("retirementAgeMessage");
              if (msgEl) msgEl.textContent = message;
            }

            // Run the function initially and whenever related inputs change
            document.addEventListener(
              "DOMContentLoaded",
              updateRetirementAgeMessage
            );
            document
              .getElementById("userRetirementAge")
              ?.addEventListener("input", updateRetirementAgeMessage);
            document
              .getElementById("userDOB")
              ?.addEventListener("input", () => {
                setTimeout(updateRetirementAgeMessage, 300); // allow age to update
              });
          </script>
          <table id="retirementTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>User Annual Contribution ($)</th>
                <th class="spouse-column">Spouse Annual Contribution ($)</th>
                <th>Rate of Return (%)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Current 401K | 403B</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="401k"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="401k"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="401k"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="401k"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="401k"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="6"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="401k">0.00</span>
                </td>
              </tr>
              <tr>
                <td>Previous 401K | Rollover 401K</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="rollover"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="rollover"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="rollover"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="rollover"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="rollover"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="6"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="rollover"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Traditional IRA | SEP-IRA</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="traditional"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="traditional"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="traditional"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="traditional"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="traditional"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="6"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="traditional"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Pension | ESPP | Annuities</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="pension"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="pension"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="pension"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="pension"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="pension"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="6"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="pension"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Roth IRA | Roth 401K</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="roth"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="roth"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="roth"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="roth"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="roth"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="6"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="roth">0.00</span>
                </td>
              </tr>
              <tr>
                <td>
                  SSA Income: Primary Insurance Amount(PIA) at Full Retirement
                  Age (FRA)
                  <a href="#" onclick="openSSAModal(event)"
                    >Refer to this link for more details</a
                  >
                  <!-- SSA Modal -->
                  <div class="modal" id="ssaModal">
                    <div class="modal-content">
                      <span class="close" onclick="closeSSAModal()"></span>
                      <h2>Social Security Benefits Table</h2>
                      <p></p>
                      1) Born on or after 1960, 67 is Full retirement Age (FRA).
                      Any claiming Age before is Early retirement, Any claiming
                      age after 67 is delayed retirement.

                      <p>
                        2) Born before 1960, 66 &amp;10 mths is Full retirement
                        Age (FRA). Any claiming Age before FRA is Early
                        retirement, Any claiming age after FRAis delayed
                        retirement.
                      </p>
                      <p>3) PIA - Your highest 35 years of indexed earnings.</p>
                      <p>
                        4) For more details on FRA and PIA, login to your
                        account at
                        <a href="https://www.ssa.gov/myaccount/" target="_blank"
                          >https://www.ssa.gov/myaccount</a
                        >
                        Once Logged In: Click on "View Your Social Security
                        Statement." You'll see a page showing: Your Estimated
                        Benefits at: Age 62 (early retirement) Full Retirement
                        Age (FRA)  this is your PIA Age 70 (delayed retirement)
                        The amount shown next to "At your full retirement age
                        (X)" is your PIA
                      </p>
                      <div class="ssa-tables">
                        <h3>Born on or after 1960</h3>
                        <table class="ssa-info-table">
                          <tr>
                            <th>Claiming Age</th>
                            <th>% of PIA</th>
                            <th>% Change vs FRA</th>
                          </tr>
                          <tr>
                            <td>62</td>
                            <td>70.00%</td>
                            <td>-30.00%</td>
                          </tr>
                          <tr>
                            <td>63</td>
                            <td>75.00%</td>
                            <td>-25.00%</td>
                          </tr>
                          <tr>
                            <td>64</td>
                            <td>80.00%</td>
                            <td>-20.00%</td>
                          </tr>
                          <tr>
                            <td>65</td>
                            <td>86.66%</td>
                            <td>-13.34%</td>
                          </tr>
                          <tr>
                            <td>66</td>
                            <td>93.33%</td>
                            <td>-6.67%</td>
                          </tr>
                          <tr>
                            <td>67 (FRA)</td>
                            <td>100.00%</td>
                            <td>0.00%</td>
                          </tr>
                          <tr>
                            <td>68</td>
                            <td>108.00%</td>
                            <td>8.00%</td>
                          </tr>
                          <tr>
                            <td>69</td>
                            <td>116.00%</td>
                            <td>16.00%</td>
                          </tr>
                          <tr>
                            <td>70</td>
                            <td>124.00%</td>
                            <td>24.00%</td>
                          </tr>
                        </table>
                        <h3>Born before 1960</h3>
                        <table class="ssa-info-table">
                          <tr>
                            <th>Claiming Age</th>
                            <th>% of PIA</th>
                            <th>% Change vs FRA</th>
                          </tr>
                          <tr>
                            <td>62</td>
                            <td>70.83%</td>
                            <td>-29.17%</td>
                          </tr>
                          <tr>
                            <td>63</td>
                            <td>75.83%</td>
                            <td>-24.17%</td>
                          </tr>
                          <tr>
                            <td>64</td>
                            <td>80.83%</td>
                            <td>-19.17%</td>
                          </tr>
                          <tr>
                            <td>65</td>
                            <td>86.67%</td>
                            <td>-13.33%</td>
                          </tr>
                          <tr>
                            <td>66</td>
                            <td>93.33%</td>
                            <td>-6.67%</td>
                          </tr>
                          <tr>
                            <td>66 &amp; 10 months</td>
                            <td>100.00%</td>
                            <td>No reduction</td>
                          </tr>
                          <tr>
                            <td>67</td>
                            <td>101.33%</td>
                            <td>1.33%</td>
                          </tr>
                          <tr>
                            <td>68</td>
                            <td>109.33%</td>
                            <td>9.33%</td>
                          </tr>
                          <tr>
                            <td>69</td>
                            <td>117.33%</td>
                            <td>17.33%</td>
                          </tr>
                          <tr>
                            <td>70</td>
                            <td>125.33%</td>
                            <td>25.33%</td>
                          </tr>
                        </table>
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="ssaPia"
                    min="0"
                    oninput="updateSSAPiaValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="ssaPia"
                    min="0"
                    oninput="updateSSAPiaValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="ssaPia"
                    disabled=""
                    min="0"
                    oninput="updateSSAPiaValue(this)"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="ssaPia"
                    disabled=""
                    min="0"
                    oninput="updateSSAPiaValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="ssaPia"
                    disabled=""
                    min="0"
                    oninput="updateSSAPiaValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="ssaPia">0.00</span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(2, 4)">Previous</button>
            <button onclick="nextSubStep(4, 4)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 4.4: Real Estate Investments -->
        <div class="sub-step" id="subStep4-4">
          <h3>Step 4.4: Real Estate Investments (USA)</h3>
          <table id="realEstateTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>Remaining Mortgage ($)</th>
                <th>Rate of Return (%)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Primary Home</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="primaryHome"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="primaryHome"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="mortgage-balance"
                    data-metric="primaryHome"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="primaryHome"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2.5"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="primaryHome"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Rental Properties</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="rentals"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="rentals"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="mortgage-balance"
                    data-metric="rentals"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="rentals"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2.5"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="rentals"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Real Estate Land Parcels</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="land"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="land"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="mortgage-balance"
                    data-metric="land"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="land"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2.5"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="land">0.00</span>
                </td>
              </tr>
              <tr>
                <td>Inheritance in the USA</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="inheritance"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="inheritance"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="mortgage-balance"
                    data-metric="inheritance"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="inheritance"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2.5"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="inheritance"
                    >0.00</span
                  >
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(3, 4)">Previous</button>
            <button onclick="nextSubStep(5, 4)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 4.5: Non-Real Estate Investments -->
        <div class="sub-step" id="subStep4-5">
          <h3>Step 4.5: Non-Real Estate Investments</h3>
          <table id="stocksBusinessIncomeTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>User Annual Contribution ($)</th>
                <th class="spouse-column">Spouse Annual Contribution ($)</th>
                <th>Rate of Return (%)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Stocks | MFs | Bonds | ETFs</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="stocks"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="stocks"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="stocks"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="stocks"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="stocks"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="7"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="stocks">0.00</span>
                </td>
              </tr>
              <tr>
                <td>Alternative Investments <a href="#" onclick="openAltInvModal(event)" style="font-size:0.9em; color:#bdb76b; text-decoration:underline; margin-left:4px;">popup</a></td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="alternatives"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="alternatives"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="alternatives"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="alternatives"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="alternatives"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="7"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="alternatives"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Certificate of Deposits (CDs)</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="cds"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="cds"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="cds"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="cds"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="cds"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="cds">0.00</span>
                </td>
              </tr>
              <tr>
                <td>Cash in Bank</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="cash"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="cash"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="user-annual-contribution"
                    data-metric="cash"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-annual-contribution"
                    data-metric="cash"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="cash"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="0.1"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="cash">0.00</span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(4, 4)">Previous</button>
            <button onclick="nextSubStep(6, 4)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 4.6: Foreign Assets -->
        <div class="sub-step" id="subStep4-6">
          <h3>Step 4.6: Foreign Assets</h3>
          <table id="foreignAssetsTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>User Present Value ($)</th>
                <th class="spouse-column">Spouse Present Value ($)</th>
                <th>Rate of Return (%)</th>
                <th>Projected Value @ Retirement ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Real Estate Properties</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="realEstateForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="realEstateForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="realEstateForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="2.5"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="realEstateForeign"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Bank Accounts</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="bankForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="bankForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="bankForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="bankForeign"
                    >0.00</span
                  >
                </td>
              </tr>
              <tr>
                <td>Inheritance</td>
                <td>
                  <input
                    class="user-present-value"
                    data-metric="inheritanceForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td class="spouse-column">
                  <input
                    class="spouse-present-value"
                    data-metric="inheritanceForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <input
                    class="rate-of-return"
                    data-metric="inheritanceForeign"
                    min="0"
                    oninput="updateProjectedValue(this, 'projected')"
                    placeholder="0"
                    step="0.1"
                    type="number"
                  />
                </td>
                <td>
                  <span class="projected-value" data-metric="inheritanceForeign"
                    >0.00</span
                  >
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(5, 4)">Previous</button>
            <button onclick="nextStep(5)">Next</button>
          </div>
        </div>
      </div>
      <!-- Step 5: Goals -->
      <div class="step" id="step5">
        <h2>Step 5: Your Financial Goals</h2>
        <!-- Sub-Step 5.1: Kids College Planning -->
        <div class="sub-step" id="subStep5-1">
          <h3>Step 5.1: Kids College Planning</h3>
          <table id="collegePlanningTable">
            <thead>
              <tr>
                <th>Child</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody id="collegePlanningTableBody">
              <!-- Rows will be added dynamically -->
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(1, 5)">Previous</button>
            <button onclick="nextSubStep(2, 5)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 5.2: Kids Wedding Planning -->
        <div class="sub-step" id="subStep5-2">
          <h3>Step 5.2: Kids Wedding Planning</h3>
          <table id="weddingPlanningTable">
            <thead>
              <tr>
                <th>Child</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody id="weddingPlanningTableBody">
              <!-- Rows will be added dynamically -->
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(1, 5)">Previous</button>
            <button onclick="nextSubStep(3, 5)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 5.3: Retirement Planning -->
        <div class="sub-step" id="subStep5-3">
          <h3>Step 5.3: Retirement Planning</h3>
          <table id="retirementGoalsTable">
            <thead>
              <tr>
                <th>
                  MONTHLY INCOME NEEDED IN TODAY'S DOLLARS (PRE-TAX) (INCLUDE
                  LIVING EXPENSES + PROPERTY TAXES + CARS + INSURANCES + FOOD +
                  UTILITIES + CLOTHING + HOME REPAIRS ETC.,)
                </th>
                <th>Amount ($)</th>
                <th>Retirement Plan Until</th>
                <th>Projected Amount ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Monthly Income Needed</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="retirement-income"
                    min="0"
                    oninput="updateGoalProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
                <td>
                  <select
                    id="retirementPlanUntil"
                    onchange="updateRetirementProjectedValue()"
                  >
                    <option value="85">85</option>
                    <option value="90">90</option>
                    <option value="95">95</option>
                  </select>
                </td>
                <td>
                  <span class="projected-value" data-metric="retirement-income"
                    >0.00</span
                  >
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(2, 5)">Previous</button>
            <button onclick="nextSubStep(4, 5)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 5.4: Health Care and Long Term Care -->
        <div class="sub-step" id="subStep5-4">
          <h3>Step 5.4: Health Care and Long Term Care @ Age of Retirement</h3>
          <table id="healthCareTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Health Care Out-of-Pocket</td>
                <td colspan="3">
                  <span id="healthCareOutOfPocketAmount">$160,000</span>
                </td>
              </tr>
              <tr>
                <td>
                  Long Term Care | Disability
                  <a href="https://www.carescout.com/cost-of-care"
                    >Refer to this link for more details
                  </a>
                </td>
                <td><span id="longTermCareAmount">$0.00</span></td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(3, 5)">Previous</button>
            <button onclick="nextSubStep(5, 5)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 5.5: Life Goals Planning -->
        <div class="sub-step" id="subStep5-5">
          <h3>Step 5.5: Life Goals Planning</h3>
          <table id="lifeGoalsTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Travel Budget</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="travel"
                    min="0"
                    oninput="updateGoalProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Vacation Home | Farm House</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="vacationHome"
                    min="0"
                    oninput="updateGoalProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Charity Foundation</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="charity"
                    min="0"
                    oninput="updateGoalProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Other Life Goals</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="otherGoals"
                    min="0"
                    oninput="updateGoalProjectedValue(this)"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(4, 5)">Previous</button>
            <button onclick="nextSubStep(6, 5)">Next</button>
          </div>
        </div>
        <!-- Sub-Step 5.6: Legacy Planning -->
        <div class="sub-step" id="subStep5-6">
          <h3>Step 5.6: Legacy Planning</h3>
          <table id="legacyPlanningTable">
            <thead>
              <tr>
                <th>Metric</th>
                <th>Amount ($)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Fund for Kids Home/Business</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="kidsFund"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Legacy Asset for Kids</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="legacyAssets"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
              <tr>
                <td>Family Support</td>
                <td>
                  <input
                    class="goal-amount"
                    data-metric="familySupport"
                    min="0"
                    step="0.01"
                    type="number"
                  />
                </td>
              </tr>
            </tbody>
          </table>
          <div class="buttons">
            <button onclick="prevSubStep(5, 5)">Previous</button>
            <button onclick="calculateResults();" type="button">
              Submit &amp; View Results
            </button>
          </div>
        </div>
      </div>
      <!-- Results Page -->
      <div class="step" id="step6">
        <h2>Your Financial Analysis Results</h2>
        <!-- Personal Overview Section -->
        <div id="personalOverview">
          <h3>Personal Overview</h3>
          <table>
            <tr>
              <td><strong>Name:</strong></td>
              <td><span id="resultName">-</span></td>
            </tr>
            <tr>
              <td><strong>Age:</strong></td>
              <td><span id="resultAge">-</span> years</td>
            </tr>
            <tr>
              <td><strong>Retirement Age:</strong></td>
              <td><span id="resultRetirementAge">-</span> years</td>
            </tr>
            <tr>
              <td><strong>Years Until Retirement:</strong></td>
              <td><span id="resultYearsToRetirement">-</span> years</td>
            </tr>
            <tr>
              <td><strong>Marital Status:</strong></td>
              <td><span id="resultMaritalStatus">-</span></td>
            </tr>
            <tr>
              <td><strong>City &amp; State:</strong></td>
              <td><span id="resultLocation">-</span></td>
            </tr>
            <tr id="willTrustRow">
              <td><strong>Will &amp; Trust:</strong></td>
              <td><span id="resultWillTrust">-</span></td>
            </tr>
            <tr id="spouseInfoSection" style="display: none">
              <td colspan="2">
                <strong>Spouse Information</strong>
                <table style="margin-left: 20px">
                  <tr>
                    <td><strong>Name:</strong></td>
                    <td><span id="resultSpouseName">-</span></td>
                  </tr>
                  <tr>
                    <td><strong>Age:</strong></td>
                    <td><span id="resultSpouseAge">-</span> years</td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr id="dependentsInfoSection" style="display: none">
              <td colspan="2">
                <strong>Dependents Information</strong>
                <table id="resultDependentsTable" style="margin-left: 20px">
                  <!-- Dependent rows will be added dynamically -->
                </table>
              </td>
            </tr>
          </table>
        </div>
        <!-- Cash Flow Overview Section -->
        <div
          id="cashFlowOverview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Cash Flow Overview</h3>
          <table style="width: 100%; border-collapse: collapse">
            <tr>
              <td><strong>Monthly Income:</strong></td>
              <td>
                <span class="total-value" id="resultMonthlyIncome">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Monthly Expenses (without Mortgage):</strong></td>
              <td>
                <span class="total-value" id="resultMonthlyExpenses">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Monthly Mortgage:</strong></td>
              <td>
                <span class="total-value" id="resultMonthlyMortgage">0.00</span>
              </td>
            </tr>
            <tr style="border-top: 1px solid #bdb76b; margin-top: 10px">
              <td><strong>Cash Flow Status:</strong></td>
              <td>
                <span class="total-value" id="resultCashFlowStatus">-</span>
              </td>
            </tr>
            <tr>
              <td><strong>Amount:</strong></td>
              <td>
                <span class="total-value" id="resultCashFlowAmount">0.00</span>
              </td>
            </tr>
          </table>
        </div>
        <!-- Emergency Fund Overview Section -->
        <div
          id="emergencyFundOverview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Emergency Fund Overview</h3>
          <table style="width: 100%; border-collapse: collapse">
            <tr>
              <td><strong>Recommended Emergency Fund (3 months):</strong></td>
              <td>
                <span class="total-value" id="resultEmergencyFund3">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Recommended Emergency Fund (6 months):</strong></td>
              <td>
                <span class="total-value" id="resultEmergencyFund6">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Current Emergency Fund:</strong></td>
              <td>
                <span class="total-value" id="resultCurrentEmergencyFund"
                  >0.00</span
                >
              </td>
            </tr>
            <tr style="border-top: 1px solid #bdb76b; margin-top: 10px">
              <td><strong>Status:</strong></td>
              <td>
                <span class="total-value" id="resultEmergencyFundStatus"
                  >-</span
                >
              </td>
            </tr>
          </table>
        </div>
        <!-- Protection Overview -->
        <div
          class="protection-overview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Protection Overview</h3>
          <table style="width: 100%; border-collapse: collapse">
            <tr>
              <td><strong>User Coverage Needed:</strong></td>
              <td>
                <span class="total-value" id="resultHouseholdCoverage"
                  >0.00</span
                >
              </td>
            </tr>
            <tr>
              <td><strong>Current Life Insurance Coverage:</strong></td>
              <td>
                <span class="total-value" id="resultCurrentLifeInsurance"
                  >0.00</span
                >
              </td>
            </tr>
            <tr>
              <td><strong>Coverage Gap:</strong></td>
              <td>
                <span class="total-value" id="resultCoverageGap">0.00</span>
              </td>
            </tr>
            <tr id="spouseCoverageSection" style="display: none">
              <td colspan="2" style="padding-top: 10px">
                <strong>Spouse Coverage</strong>
                <table style="width: 100%; margin-top: 5px">
                  <tr>
                    <td><strong>Coverage Needed:</strong></td>
                    <td>
                      <span class="total-value" id="resultSpouseCoverageNeeded"
                        >0.00</span
                      >
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Current Coverage:</strong></td>
                    <td>
                      <span class="total-value" id="resultSpouseCurrentCoverage"
                        >0.00</span
                      >
                    </td>
                  </tr>
                  <tr>
                    <td><strong>Coverage Gap:</strong></td>
                    <td>
                      <span class="total-value" id="resultSpouseCoverageGap"
                        >0.00</span
                      >
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </div>
        <!-- Debt Summary -->
        <div class="debt-overview">
          <h3>Debt Summary</h3>
          <table>
            <tr>
              <td><strong>Total Debt:</strong></td>
              <td>
                <span class="total-value" id="resultTotalDebt">0.00</span>
              </td>
            </tr>
            <tr>
              <td><strong>Priority Focus:</strong></td>
              <td><span id="resultDebtAction">-</span></td>
            </tr>
          </table>
          <div id="resultDebtRecommendations" style="margin-top: 10px">
            <!-- Recommendations will be populated dynamically -->
          </div>
        </div>
        <!-- College Planning Overview -->
        <div
          class="college-planning-overview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>College Planning Overview</h3>
          <div id="collegePlanningOverview">
            <!-- Will be populated dynamically -->
          </div>
        </div>
        <script>
          function updateCollegePlanningOverview() {
            const dependentsCount =
              parseInt(document.getElementById("dependents").value) || 0;
            const overviewDiv = document.getElementById(
              "collegePlanningOverview"
            );

            if (dependentsCount === 0) {
              overviewDiv.innerHTML =
                "<p>No dependents added for college planning.</p>";
              return;
            }

            let html =
              '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += `
                <thead>
                    <tr>
                        <th style="text-align: left;">Dependent</th>
                        <th style="text-align: center;">Years Until College</th>
                        <th style="text-align: right;">Goal Amount ($)</th>
                        <th style="text-align: right;">Current Savings ($)</th>
                        <th style="text-align: right;">Projected Amount ($)</th>
                        <th style="text-align: right;">Gap Amount ($)</th>
                    </tr>
                </thead>
                <tbody>
            `;

            for (let i = 1; i <= dependentsCount; i++) {
              const name =
                document.getElementById(`dependentName${i}`)?.value ||
                `Child ${i}`;
              const collegeData =
                financialData.assets.college[`child${i}`] || {};
              const goalAmount =
                parseFloat(
                  document.querySelector(
                    `.goal-amount[data-metric="college-child${i}"]`
                  )?.value
                ) || 0;

              // Get Cash Value Life Insurance amount if it's designated for college and this is the first child
              let additionalCollegeFunds = 0;
              if (i === 1) {
                // Only for the first child
                const cashValuePurpose = document.querySelector(
                  '.purpose[data-metric="cashValue"]'
                )?.value;
                if (cashValuePurpose === "college") {
                  const userCashValue =
                    parseFloat(
                      document.querySelector(
                        '.user-present-value[data-metric="cashValue"]'
                      )?.value
                    ) || 0;
                  const spouseCashValue =
                    parseFloat(
                      document.querySelector(
                        '.spouse-present-value[data-metric="cashValue"]'
                      )?.value
                    ) || 0;
                  additionalCollegeFunds = userCashValue + spouseCashValue;
                }
              }

              const presentValue =
                (collegeData.presentValue || 0) + additionalCollegeFunds;
              const projectedValue =
                (collegeData.projectedValue || 0) + additionalCollegeFunds;
              const yearsUntilCollege = collegeData.yearsToCollege || 0;

              // Calculate gap
              const gap = goalAmount - projectedValue;
              const gapColor = gap > 0 ? "#ff5555" : "#4CAF50";

              html += `
                    <tr>
                        <td style="text-align: left;">${name}</td>
                        <td style="text-align: center;">${yearsUntilCollege}</td>
                        <td style="text-align: right;">${goalAmount.toLocaleString(
                          "en-US",
                          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                        )}</td>
                        <td style="text-align: right;">${presentValue.toLocaleString(
                          "en-US",
                          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                        )}</td>
                        <td style="text-align: right;">${projectedValue.toLocaleString(
                          "en-US",
                          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                        )}</td>
                        <td style="text-align: right; color: ${gapColor};">${Math.abs(
                gap
              ).toLocaleString("en-US", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}</td>
                    </tr>
                `;
            }

            html += "</tbody></table>";

            // Add summary section
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #2a2a2a; border-radius: 4px;">
                    <h4 style="margin-top: 0;">Summary Notes:</h4>
                    <ul style="list-style-type: none; padding-left: 10px;">
                        <li> Goal amounts should be adjusted based on specific college choices and inflation</li>
                        <li> Consider additional funding sources (scholarships, grants, loans)</li>
                        <li> Review and adjust savings strategy annually</li>
                    </ul>
                </div>
            `;

            overviewDiv.innerHTML = html;
          }

          // Add event listeners to update the overview when values change
          document.addEventListener("DOMContentLoaded", function () {
            // Initial update
            updateCollegePlanningOverview();

            // Update when dependents count changes
            document
              .getElementById("dependents")
              ?.addEventListener("input", updateCollegePlanningOverview);

            // Update when any college planning values change
            document.addEventListener("input", function (e) {
              if (
                e.target.matches(".present-value, .goal-amount") ||
                e.target.id.startsWith("dependentName") ||
                e.target.id.startsWith("dependentDOB")
              ) {
                updateCollegePlanningOverview();
              }
            });
          });
        </script>

        <p style="text-align: center; font-size: 0.9em">
          FOR EDUCATION PURPOSE ONLY. WE DO NOT PROVIDE LEGAL OR TAX ADVICE.
        </p>
        <div class="buttons">
          <button onclick="showRetirementPlanning()">Next</button>
        </div>
      </div>
      <!-- Retirement Planning Page -->
      <div class="step" id="step7">
        <h2>Retirement Planning Overview</h2>
        <div
          class="retirement-planning-overview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Expected Monthly Income from Goals Retirement Planning</h3>
          <!-- GAP Analysis Section -->
          <div class="gap-analysis" style="margin-bottom: 20px">
            <h4 style="color: #bdb76b; margin-bottom: 10px">GAP Analysis</h4>
            <div id="gapAnalysis">
              <!-- Will be populated dynamically -->
            </div>
          </div>
          <!-- Projected Payouts Table -->
          <table
            style="width: 100%; border-collapse: collapse; margin-top: 20px"
          >
            <thead>
              <tr>
                <th>Product</th>
                <th>Income Type</th>
                <th>Tax Status</th>
                <th>Projected Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>401k/403B (4% rule)</td>
                <td>Non Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projected401k">0.00</span></td>
              </tr>
              <tr>
                <td>Traditional IRA</td>
                <td>Non Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projectedIRA">0.00</span></td>
              </tr>
              <tr>
                <td>Roth IRA (4% rule)</td>
                <td>Non Guaranteed</td>
                <td>No Tax</td>
                <td><span id="projectedRothIRA">0.00</span></td>
              </tr>
              <tr>
                <td>Annuity - Life Time Income</td>
                <td>Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projectedAnnuity">0.00</span></td>
              </tr>
              <tr>
                <td>SSA</td>
                <td>Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projectedSSA">30,000.00</span></td>
              </tr>
              <tr>
                <td>Rental Income (less 20% maintenance cost)</td>
                <td>Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projectedRental">0.00</span></td>
              </tr>
              <tr>
                <td>Business Revenue</td>
                <td>Non Guaranteed</td>
                <td>Taxable</td>
                <td><span id="projectedBusiness">0.00</span></td>
              </tr>
              <tr style="border-top: 2px solid #bdb76b">
                <td colspan="3"><strong>Total</strong></td>
                <td>
                  <strong><span id="projectedTotal">0.00</span></strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <p style="text-align: center; font-size: 0.9em">
          FOR EDUCATION PURPOSE ONLY. WE DO NOT PROVIDE LEGAL OR TAX ADVICE.
        </p>
        <div class="buttons">
          <button onclick="showStep(6)">Previous</button>
          <button onclick="showHealthCareAndLegacyOverview()">Next</button>
        </div>
      </div>
      <!-- Health Care and Legacy Overview Page -->
      <div class="step" id="step8">
        <h2>Health Care and Legacy Overview</h2>
        <!-- Health Care Overview Section -->
        <div
          class="health-care-overview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Health Care Overview</h3>
          <!-- Required Long Term Care Section -->
          <div class="long-term-care-section" style="margin-bottom: 20px">
            <h4 style="color: #bdb76b; margin-bottom: 10px">
              Required Long Term Care
            </h4>
            <table style="width: 100%; border-collapse: collapse">
              <tr>
                <td>Required projected Long Term care:</td>
                <td><span id="requiredLongTermCare">0.00</span></td>
              </tr>
              <tr>
                <td>GAP:</td>
                <td>
                  <span id="longTermCareGap" style="color: #ff5555">0.00</span>
                </td>
              </tr>
            </table>
          </div>
          <!-- Health Care Expenses Section -->
          <div class="health-care-expenses-section">
            <h4 style="color: #bdb76b; margin-bottom: 10px">
              Health Care Expenses
            </h4>
            <table style="width: 100%; border-collapse: collapse">
              <tr>
                <td>Required Health Expenses at retirement:</td>
                <td><span id="requiredHealthExpenses">0.00</span></td>
              </tr>
              <tr>
                <td>GAP:</td>
                <td>
                  <span id="healthExpensesGap" style="color: #ff5555"
                    >0.00</span
                  >
                </td>
              </tr>
            </table>
          </div>
          <!-- Summary Notes -->
          <div
            style="
              margin-top: 15px;
              padding: 10px;
              background: #2a2a2a;
              border-radius: 4px;
            "
          >
            <h4 style="margin-top: 0">Summary Notes:</h4>
            <ul style="list-style-type: none; padding-left: 10px">
              <li>
                 Health care costs are based on current estimates and may
                change
              </li>
              <li>
                 Consider Medicare coverage options and supplemental insurance
              </li>
              <li> Review long-term care insurance options</li>
            </ul>
          </div>
        </div>
        <!-- Legacy Overview Section -->
        <div
          class="legacy-overview"
          style="
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #bdb76b;
            font-size: 0.9em;
          "
        >
          <h3>Legacy Overview</h3>
          <!-- Legacy Goals Section -->
          <div class="legacy-goals-section">
            <h4 style="color: #bdb76b; margin-bottom: 10px">
              Legacy Goals Analysis
            </h4>
            <table style="width: 100%; border-collapse: collapse">
              <tr>
                <td>Goal Amount:</td>
                <td><span id="legacyGoalAmount">0.00</span></td>
              </tr>
              <tr>
                <td>Projected Real estate investment:</td>
                <td><span id="projectedRealEstate">0.00</span></td>
              </tr>
              <tr>
                <td>Projected Non-Real estate investment:</td>
                <td><span id="projectedNonRealEstate">0.00</span></td>
              </tr>
              <tr>
                <td>GAP:</td>
                <td><span id="legacyGap" style="color: #ff5555">0.00</span></td>
              </tr>
            </table>
          </div>
          <!-- Summary Notes -->
          <div
            style="
              margin-top: 15px;
              padding: 10px;
              background: #2a2a2a;
              border-radius: 4px;
            "
          >
            <h4 style="margin-top: 0">Summary Notes:</h4>
            <ul style="list-style-type: none; padding-left: 10px">
              <li> Review estate planning documents regularly</li>
              <li> Consider tax implications of inheritance</li>
              <li> Discuss legacy plans with financial advisor</li>
            </ul>
          </div>
        </div>
        <p style="text-align: center; font-size: 0.9em">
          FOR EDUCATION PURPOSE ONLY. WE DO NOT PROVIDE LEGAL OR TAX ADVICE.
        </p>
        <div class="buttons">
          <button onclick="showStep(7)">Previous</button>
          <button onclick="resetWizard()">Start Over</button>
          <button
            onclick="generatePDF()"
            style="
              background-color: #4caf50;
              color: #fff;
              border-radius: 4px;
              margin-left: 10px;
            "
          >
            Save as PDF
          </button>
        </div>
      </div>
    </div>
    <script>
      let currentStep = 1;
      let currentSubStep2 = 1; // Track the sub-step within Step 2 (Cash Flow)
      let currentSubStep3 = 1; // Track the sub-step within Step 3 (Debt)
      let currentSubStep4 = 1; // Track the sub-step within Step 4 (Assets)
      let currentSubStep5 = 1; // Track the sub-step within Step 5 (Goals)

      const totalSubSteps2 = 1; // Cash Flow has 1 sub-step
      const totalSubSteps3 = 1; // Debt has 1 sub-step
      const totalSubSteps4 = 6; // Assets has 6 sub-steps
      const totalSubSteps5 = 6; // Goals has 6 sub-steps

      // Initialize the wizard
      document.addEventListener("DOMContentLoaded", function () {
        showStep(1);
        toggleSpouseSection();
        updateAllProjectedValues();
      });

      function navigateToStep(step) {
        updateAllProjectedValues();

        // If trying to navigate to results (step 6), calculate first
        if (step === 6) {
          calculateAndShowResults();
          return;
        }

        currentStep = step;

        // Reset sub-step counters when navigating to a new step
        if (step === 2) {
          currentSubStep2 = 1;
        } else if (step === 3) {
          currentSubStep3 = 1;
        } else if (step === 4) {
          currentSubStep4 = 1;
        } else if (step === 5) {
          currentSubStep5 = 1;
        }

        showStep(step);
      }

      function showStep(step) {
        // Update current step
        currentStep = step;

        // Hide all steps first
        document
          .querySelectorAll(".step")
          .forEach((el) => el.classList.remove("active"));

        // Show the current step
        const currentStepEl = document.getElementById(`step${step}`);
        if (currentStepEl) {
          currentStepEl.classList.add("active");

          // Update tab highlighting
          document
            .querySelectorAll(".wizard-tabs a")
            .forEach((tab) => tab.classList.remove("active"));
          const tabs = document.querySelectorAll(".wizard-tabs a");
          if (tabs[step - 1]) {
            tabs[step - 1].classList.add("active");
          }

          // Show appropriate sub-step
          if (step === 2) {
            showSubStep(currentSubStep2, 2);
          } else if (step === 3) {
            showSubStep(currentSubStep3, 3);
          } else if (step === 4) {
            showSubStep(currentSubStep4, 4);
          } else if (step === 5) {
            showSubStep(currentSubStep5, 5);
          }
        }

        updateAllProjectedValues();
      }

      function hasDependents() {
        const dependentsSection = document.getElementById("dependentsSection");
        return dependentsSection && dependentsSection.children.length > 0;
      }

      function isStepDependentRelated(step, subStep) {
        const dependentSteps = {
          4: [1], // Step 4.1 (College Fund Savings)
          5: [1, 2], // Steps 5.1 (Kids college planning) and 5.2 (kids wedding plan)
        };
        return dependentSteps[step] && dependentSteps[step].includes(subStep);
      }

      function getNextValidSubStep(step, currentSubStep) {
        let nextSubStep = currentSubStep + 1;
        const maxSubSteps = {
          2: totalSubSteps2,
          3: totalSubSteps3,
          4: totalSubSteps4,
          5: totalSubSteps5,
        };

        while (nextSubStep <= maxSubSteps[step]) {
          if (!isStepDependentRelated(step, nextSubStep) || hasDependents()) {
            return nextSubStep;
          }
          nextSubStep++;
        }
        return nextSubStep;
      }

      function getPrevValidSubStep(step, currentSubStep) {
        let prevSubStep = currentSubStep - 1;

        while (prevSubStep >= 1) {
          if (!isStepDependentRelated(step, prevSubStep) || hasDependents()) {
            return prevSubStep;
          }
          prevSubStep--;
        }
        return prevSubStep;
      }

      function showSubStep(subStep, step) {
        // Skip dependent-related steps if there are no dependents
        if (isStepDependentRelated(step, subStep) && !hasDependents()) {
          const nextValid = getNextValidSubStep(step, subStep);
          if (nextValid <= (step === 4 ? totalSubSteps4 : totalSubSteps5)) {
            showSubStep(nextValid, step);
            return;
          } else {
            nextStep(step + 1);
            return;
          }
        }

        const stepElement = document.getElementById(`step${step}`);
        if (!stepElement) return;

        // Hide all sub-steps in the current step
        stepElement.querySelectorAll(".sub-step").forEach((el) => {
          el.classList.remove("active");
          el.style.display = "none";
        });

        // Show the target sub-step
        const subStepElement = document.getElementById(
          `subStep${step}-${subStep}`
        );
        if (subStepElement) {
          subStepElement.classList.add("active");
          subStepElement.style.display = "block";

          // Update the current sub-step counter
          if (step === 2) {
            currentSubStep2 = subStep;
          } else if (step === 3) {
            currentSubStep3 = subStep;
          } else if (step === 4) {
            currentSubStep4 = subStep;
          } else if (step === 5) {
            currentSubStep5 = subStep;
          }

          // Save current state
          saveFinancialData();
        }

        updateAllProjectedValues();
      }

      function nextStep(step) {
        updateAllProjectedValues();
        if (step === 2) {
          currentSubStep2 = 1; // Reset to first sub-step of Cash Flow
        } else if (step === 3) {
          currentSubStep3 = 1; // Reset to first sub-step of Debt
        } else if (step === 4) {
          currentSubStep4 = 1; // Reset to first sub-step of Assets
        } else if (step === 5) {
          currentSubStep5 = 1; // Reset to first sub-step of Goals
        }
        showStep(step);
      }

      function prevStep(step) {
        updateAllProjectedValues();
        if (step === 2) {
          currentSubStep2 = totalSubSteps2;
        } else if (step === 3) {
          currentSubStep3 = totalSubSteps3;
        } else if (step === 4) {
          currentSubStep4 = totalSubSteps4;
        } else if (step === 5) {
          currentSubStep5 = totalSubSteps5;
        }
        showStep(step);
      }

      function nextSubStep(nextSubStep, step) {
        updateAllProjectedValues();

        // Get the next valid sub-step
        const validNextSubStep = getNextValidSubStep(step, nextSubStep - 1);

        if (step === 2 && validNextSubStep <= totalSubSteps2) {
          showSubStep(validNextSubStep, 2);
        } else if (step === 3 && validNextSubStep <= totalSubSteps3) {
          showSubStep(validNextSubStep, 3);
        } else if (step === 4 && validNextSubStep <= totalSubSteps4) {
          showSubStep(validNextSubStep, 4);
          // If we're at the last sub-step of assets and trying to go next
          if (validNextSubStep > totalSubSteps4) {
            nextStep(5); // Move to the Goals section
          }
        } else if (step === 5 && validNextSubStep <= totalSubSteps5) {
          showSubStep(validNextSubStep, 5);
        }
      }

      function prevSubStep(prevSubStep, step) {
        updateAllProjectedValues();

        // Get the previous valid sub-step
        const validPrevSubStep = getPrevValidSubStep(step, prevSubStep + 1);

        if (step === 2) {
          if (validPrevSubStep >= 1) {
            showSubStep(validPrevSubStep, 2);
          } else {
            prevStep(1);
          }
        } else if (step === 3) {
          if (validPrevSubStep >= 1) {
            showSubStep(validPrevSubStep, 3);
          } else {
            prevStep(2);
          }
        } else if (step === 4) {
          if (validPrevSubStep >= 1) {
            showSubStep(validPrevSubStep, 4);
          } else {
            prevStep(3);
          }
        } else if (step === 5) {
          if (validPrevSubStep >= 1) {
            showSubStep(validPrevSubStep, 5);
          } else {
            prevStep(4);
          }
        }
      }

      function calculateAge(person) {
        const dobInput = document.getElementById(`${person}DOB`).value;
        const ageSpan = document.getElementById(`${person}Age`);
        if (!dobInput) {
          ageSpan.textContent = "0";
          return 0;
        }

        // Parse mm/yyyy format
        const [month, year] = dobInput.split("/").map(Number);
        if (
          !month ||
          !year ||
          month < 1 ||
          month > 12 ||
          year < 1900 ||
          year > new Date().getFullYear()
        ) {
          ageSpan.textContent = "Invalid";
          return 0;
        }

        // Calculate age based on current date (March 26, 2025)
        const currentDate = new Date(2025, 2, 26); // March 26, 2025
        const birthDate = new Date(year, month - 1, 1); // First day of the birth month
        let age = currentDate.getFullYear() - birthDate.getFullYear();
        const monthDiff = currentDate.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && currentDate.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        ageSpan.textContent = age;
        return age;
      }

      function calculateDependentAge(index) {
        const dobInput = document.getElementById(`dependentDOB${index}`).value;
        const ageSpan = document.getElementById(`dependentAge${index}`);
        if (!dobInput) {
          ageSpan.textContent = "0";
          return 0;
        }

        // Parse mm/yyyy format
        const [month, year] = dobInput.split("/").map(Number);
        if (
          !month ||
          !year ||
          month < 1 ||
          month > 12 ||
          year < 1900 ||
          year > new Date().getFullYear()
        ) {
          ageSpan.textContent = "Invalid";
          return 0;
        }

        // Calculate age based on current date (March 26, 2025)
        const currentDate = new Date(2025, 2, 26); // March 26, 2025
        const birthDate = new Date(year, month - 1, 1); // First day of the birth month
        let age = currentDate.getFullYear() - birthDate.getFullYear();
        const monthDiff = currentDate.getMonth() - birthDate.getMonth();
        if (
          monthDiff < 0 ||
          (monthDiff === 0 && currentDate.getDate() < birthDate.getDate())
        ) {
          age--;
        }
        ageSpan.textContent = age;
        return age;
      }

      function toggleSpouseSection() {
        const maritalStatus = document.getElementById("maritalStatus").value;
        const spouseSection = document.getElementById("spouseSection");
        const spouseColumns = document.querySelectorAll(".spouse-column");
        const spouseInputs = document.querySelectorAll(
          ".spouse-present-value, .spouse-annual-contribution"
        );

        if (maritalStatus === "Married") {
          spouseSection.style.display = "block";
          spouseColumns.forEach((col) => (col.style.display = "table-cell"));
          spouseInputs.forEach((input) => {
            input.disabled = false;
            input.style.display = "block";
          });
        } else {
          spouseSection.style.display = "none";
          spouseColumns.forEach((col) => (col.style.display = "none"));
          spouseInputs.forEach((input) => {
            input.disabled = true;
            input.style.display = "none";
            input.value = ""; // Clear spouse values when switching to single
          });
          // Update all projected values after clearing spouse inputs
          updateAllProjectedValues();
        }
      }

      function toggleWillTrustFunding() {
        const willTrustStatus =
          document.getElementById("willTrustStatus").value;
        const fundingRow = document.getElementById("willTrustFundingRow");

        if (willTrustStatus === "YES") {
          fundingRow.style.display = "table-row";
        } else {
          fundingRow.style.display = "none";
          document.getElementById("willTrustFunding").value = "Not Funded";
        }
      }

      function updateDependentsSection() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const dependentsSection = document.getElementById("dependentsSection");
        dependentsSection.innerHTML = "";

        if (dependentsCount > 0) {
          let html =
            "<h3>Dependents Information</h3><table><tr><th>Dependent</th><th>Name</th><th>Date of Birth (mm/yyyy)</th><th>Current Age</th></tr>";
          for (let i = 1; i <= dependentsCount; i++) {
            html += `
                        <tr>
                            <td>Dependent ${i}</td>
                            <td><input type="text" id="dependentName${i}" placeholder="Enter name"></td>
                            <td><input type="text" id="dependentDOB${i}" placeholder="mm/yyyy" oninput="calculateDependentAge(${i})"></td>
                            <td><span id="dependentAge${i}" class="calculated-age">0</span></td>
                        </tr>
                    `;
          }
          html += "</table>";
          dependentsSection.innerHTML = html;
        }
      }

      function getYearsToRetirement() {
        const userAge = calculateAge("user");
        const userRetirementAge =
          parseFloat(document.getElementById("userRetirementAge").value) || 65;

        const userYearsToRetirement = Math.max(0, userRetirementAge - userAge);

        // Show error message if years is 0
        const retirementError = document.getElementById("retirementError");
        if (userYearsToRetirement === 0 && currentStep === 2) {
          retirementError.style.display = "block";
        } else {
          retirementError.style.display = "none";
        }

        return userYearsToRetirement;
      }

      function calculateForeignAssetProjectedValue(presentValue, rate, years) {
        // Formula: PV * (1 + r) * (1 + r)^n
        return presentValue * (1 + rate) * Math.pow(1 + rate, years);
      }

      function updateProjectedValue(input, type) {
        const metric = input.getAttribute("data-metric");
        const years = getYearsToRetirement();
        const maritalStatus = document.getElementById("maritalStatus").value;
        const table = input.closest("table");

        const projectedSpan = document.querySelector(
          `.${
            type === "future" ? "future" : "projected"
          }-value[data-metric="${metric}"]`
        );
        if (!projectedSpan) {
          console.error(`Projected span not found for metric: ${metric}`);
          return;
        }

        // For Retirement Planning table
        if (table && table.id === "retirementTable") {
          const userPresentValueInput = document.querySelector(
            `#retirementTable .user-present-value[data-metric="${metric}"]`
          );
          const spousePresentValueInput = document.querySelector(
            `#retirementTable .spouse-present-value[data-metric="${metric}"]`
          );
          const rateInput = document.querySelector(
            `#retirementTable .rate-of-return[data-metric="${metric}"]`
          );
          const userContributionInput = document.querySelector(
            `#retirementTable .user-annual-contribution[data-metric="${metric}"]`
          );
          const spouseContributionInput = document.querySelector(
            `#retirementTable .spouse-annual-contribution[data-metric="${metric}"]`
          );

          const userPresentValue = parseFloat(userPresentValueInput.value) || 0;
          const spousePresentValue =
            maritalStatus === "Married"
              ? parseFloat(spousePresentValueInput.value) || 0
              : 0;
          const totalPresentValue = userPresentValue + spousePresentValue;
          const rateOfReturn = parseFloat(rateInput.value) || 6; // Default to 6% if not provided
          const userAnnualContribution =
            parseFloat(userContributionInput.value) || 0;
          const spouseAnnualContribution =
            maritalStatus === "Married"
              ? parseFloat(spouseContributionInput.value) || 0
              : 0;
          const totalAnnualContribution =
            userAnnualContribution + spouseAnnualContribution;

          const rate = rateOfReturn / 100;
          const projectedValue = calculateRetirementProjectedValue(
            totalPresentValue,
            rate,
            years,
            totalAnnualContribution
          );
          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
        // For Stocks | Business | Income table
        else if (
          input.closest("table") &&
          input.closest("table").id === "stocksBusinessIncomeTable"
        ) {
          const userPresentValueInput = document.querySelector(
            `#stocksBusinessIncomeTable .user-present-value[data-metric="${metric}"]`
          );
          const spousePresentValueInput = document.querySelector(
            `#stocksBusinessIncomeTable .spouse-present-value[data-metric="${metric}"]`
          );
          const rateInput = document.querySelector(
            `#stocksBusinessIncomeTable .rate-of-return[data-metric="${metric}"]`
          );
          const userContributionInput = document.querySelector(
            `#stocksBusinessIncomeTable .user-annual-contribution[data-metric="${metric}"]`
          );
          const spouseContributionInput = document.querySelector(
            `#stocksBusinessIncomeTable .spouse-annual-contribution[data-metric="${metric}"]`
          );

          const userPresentValue = parseFloat(userPresentValueInput.value) || 0;
          const spousePresentValue =
            maritalStatus === "Married"
              ? parseFloat(spousePresentValueInput.value) || 0
              : 0;
          const totalPresentValue = userPresentValue + spousePresentValue;

          // Set default rates based on metric
          let defaultRate = 7; // Default for stocks
          if (metric === "cds") {
            defaultRate = 2; // Default for CDs
          } else if (metric === "cash") {
            defaultRate = 0.1; // Default for Cash in Bank
          }

          const rateOfReturn = parseFloat(rateInput.value) || defaultRate;
          const userAnnualContribution =
            parseFloat(userContributionInput.value) || 0;
          const spouseAnnualContribution =
            maritalStatus === "Married"
              ? parseFloat(spouseContributionInput.value) || 0
              : 0;
          const totalAnnualContribution =
            userAnnualContribution + spouseAnnualContribution;

          const rate = rateOfReturn / 100;
          const projectedValue = calculateRetirementProjectedValue(
            totalPresentValue,
            rate,
            years,
            totalAnnualContribution
          );
          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
        // For Real Estate table
        else if (
          input.closest("table") &&
          input.closest("table").id === "realEstateTable"
        ) {
          const userPresentValueInput = document.querySelector(
            `#realEstateTable .user-present-value[data-metric="${metric}"]`
          );
          const spousePresentValueInput = document.querySelector(
            `#realEstateTable .spouse-present-value[data-metric="${metric}"]`
          );
          const mortgageInput = document.querySelector(
            `#realEstateTable .mortgage-balance[data-metric="${metric}"]`
          );
          const rateInput = document.querySelector(
            `#realEstateTable .rate-of-return[data-metric="${metric}"]`
          );

          const userPresentValue = parseFloat(userPresentValueInput.value) || 0;
          const spousePresentValue =
            maritalStatus === "Married"
              ? parseFloat(spousePresentValueInput.value) || 0
              : 0;
          const totalPresentValue = userPresentValue + spousePresentValue;
          const mortgageBalance = parseFloat(mortgageInput.value) || 0;
          const rateOfReturn = parseFloat(rateInput.value) || 2.5; // Default to 2.5% if not provided

          const rate = rateOfReturn / 100;
          const projectedValue = calculateRetirementProjectedValue(
            totalPresentValue - mortgageBalance,
            rate,
            years,
            0 // No annual contribution for real estate
          );
          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
        // For Foreign Assets table
        else if (
          input.closest("table") &&
          input.closest("table").id === "foreignAssetsTable"
        ) {
          const userPresentValueInput = document.querySelector(
            `#foreignAssetsTable .user-present-value[data-metric="${metric}"]`
          );
          const spousePresentValueInput = document.querySelector(
            `#foreignAssetsTable .spouse-present-value[data-metric="${metric}"]`
          );
          const rateInput = document.querySelector(
            `#foreignAssetsTable .rate-of-return[data-metric="${metric}"]`
          );

          const userPresentValue = parseFloat(userPresentValueInput.value) || 0;
          const spousePresentValue =
            maritalStatus === "Married"
              ? parseFloat(spousePresentValueInput.value) || 0
              : 0;
          const totalPresentValue = userPresentValue + spousePresentValue;
          const rateOfReturn =
            parseFloat(rateInput.value) ||
            (metric === "realEstateForeign" ? 2.5 : 0);
          const rate = rateOfReturn / 100;

          const projectedValue = calculateForeignAssetProjectedValue(
            totalPresentValue,
            rate,
            years
          );

          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
        // For Family Protection & Insurance table
        else if (
          input.closest("table") &&
          input.closest("table").id === "familyProtectionTable"
        ) {
          // Skip projection for Life Insurance at Work and Outside Work
          if (
            metric === "lifeWork" ||
            metric === "lifeOutside" ||
            metric === "disability" ||
            metric === "longTermCare"
          ) {
            // Update financial data store with just present value
            updateFinancialDataStore(input);
            return;
          }

          const userPresentValueInput = document.querySelector(
            `#familyProtectionTable .user-present-value[data-metric="${metric}"]`
          );
          const spousePresentValueInput = document.querySelector(
            `#familyProtectionTable .spouse-present-value[data-metric="${metric}"]`
          );
          const rateInput = document.querySelector(
            `#familyProtectionTable .rate-of-return[data-metric="${metric}"]`
          );
          const userContributionInput = document.querySelector(
            `#familyProtectionTable .user-annual-contribution[data-metric="${metric}"]`
          );
          const spouseContributionInput = document.querySelector(
            `#familyProtectionTable .spouse-annual-contribution[data-metric="${metric}"]`
          );

          const userPresentValue = parseFloat(userPresentValueInput.value) || 0;
          const spousePresentValue =
            maritalStatus === "Married"
              ? parseFloat(spousePresentValueInput.value) || 0
              : 0;
          const totalPresentValue = userPresentValue + spousePresentValue;
          let defaultRate;
          if (metric === "cashValue") {
            defaultRate = 6.65; // 6.65% for Cash Value Life Insurance
          } else if (metric === "hsa") {
            defaultRate = 4; // 4% for HSA
          }
          const rateOfReturn = parseFloat(rateInput.value) || defaultRate;
          const userAnnualContribution =
            parseFloat(userContributionInput.value) || 0;
          const spouseAnnualContribution =
            maritalStatus === "Married"
              ? parseFloat(spouseContributionInput.value) || 0
              : 0;
          const totalAnnualContribution =
            userAnnualContribution + spouseAnnualContribution;

          const rate = rateOfReturn / 100;
          const projectedValue = calculateRetirementProjectedValue(
            totalPresentValue,
            rate,
            years,
            totalAnnualContribution
          );
          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
        // For other tables
        else {
          const presentValue = parseFloat(input.value) || 0;
          const projectedValue = calculateProjectedValue(
            presentValue,
            type,
            years
          );
          projectedSpan.textContent = projectedValue.toFixed(2);

          // Update financial data store
          updateFinancialDataStore(input);
        }
      }

      function calculateRetirementProjectedValue(
        presentValue,
        rate,
        years,
        annualContribution
      ) {
        //  P(1+i)^n + A((1+i)^n - 1)/i
        const compoundPrincipal = presentValue * Math.pow(1 + rate, years);
        const compoundContribution =
          ((annualContribution * (Math.pow(1 + rate, years) - 1)) / rate) *
          (1 + rate);
        return compoundPrincipal + compoundContribution;
      }
      function calculateProjectedValue(presentValue, type, years) {
        const rate = 0.05; // 5% growth rate (placeholder for non-retirement tables)
        if (type === "projected") {
          return presentValue * (1 + rate) * Math.pow(1 + rate, years); // Added (1 + rate) for start-of-year compounding
        } else if (type === "future") {
          return presentValue; // Placeholder until specific formula provided
        }
        return presentValue; // Default
      }

      function updateGoalProjectedValue(input) {
        const amount = parseFloat(input.value) || 0;
        const metric = input.getAttribute("data-metric");
        const years = getYearsToRetirement();

        const projectedSpan = document.querySelector(
          `.projected-value[data-metric="${metric}"]`
        );
        if (!projectedSpan) {
          console.error(`Projected span not found for metric: ${metric}`);
          return;
        }

        const projectedAmount = calculateGoalValue(amount, years);
        projectedSpan.textContent = projectedAmount.toFixed(2);
      }

      function calculateGoalValue(amount, years) {
        const inflationRate = 0.03; // 3% inflation rate (placeholder)
        return amount * Math.pow(1 + inflationRate, years);
      }

      function updateAllProjectedValues() {
        // Update cash flow values first
        document.querySelectorAll("#cashFlowTable tr").forEach((row) => {
          const input = row.querySelector(".user-present-value");
          if (input) {
            updateCashFlowProjectedValue(input);
          }
        });

        // Then update all other values
        document
          .querySelectorAll(
            ".user-present-value, .spouse-present-value, .user-annual-contribution, .spouse-annual-contribution"
          )
          .forEach((input) => {
            if (!input.closest("#cashFlowTable")) {
              // Skip cash flow table since we already handled it
              const type =
                input.closest("table").id === "familyProtectionTable"
                  ? "future"
                  : "projected";
              updateProjectedValue(input, type);
            }
          });

        document.querySelectorAll(".goal-amount").forEach((input) => {
          updateGoalProjectedValue(input);
        });

        document
          .querySelectorAll(
            ".rate-of-return, .mortgage-balance, .mortgage-years, .mortgage-rate"
          )
          .forEach((input) => {
            const type =
              input.closest("table").id === "familyProtectionTable"
                ? "future"
                : "projected";
            updateProjectedValue(input, type);
          });
      }

      function calculateResults() {
        try {
          // Validate required fields first
          if (!validateRequiredFields()) {
            alert("Please fill in all required fields before submitting.");
            return;
          }

          // Update Personal Overview
          document.getElementById("resultName").textContent =
            document.getElementById("userName").value || "-";
          document.getElementById("resultAge").textContent =
            document.getElementById("userAge").textContent || "-";
          document.getElementById("resultRetirementAge").textContent =
            document.getElementById("userRetirementAge").value || "-";
          document.getElementById("resultYearsToRetirement").textContent =
            getYearsToRetirement() || "-";
          document.getElementById("resultMaritalStatus").textContent =
            document.getElementById("maritalStatus").value || "-";
          document.getElementById("resultLocation").textContent =
            document.getElementById("cityState").value || "-";

          // Update Will & Trust Information
          const willTrustStatus =
            document.getElementById("willTrustStatus").value;
          const willTrustFunding =
            willTrustStatus === "YES"
              ? ` (${document.getElementById("willTrustFunding").value})`
              : "";
          document.getElementById(
            "resultWillTrust"
          ).textContent = `${willTrustStatus}${willTrustFunding}`;

          // Handle spouse information
          const maritalStatus = document.getElementById("maritalStatus").value;
          const spouseInfoSection =
            document.getElementById("spouseInfoSection");
          if (maritalStatus === "Married") {
            spouseInfoSection.style.display = "table-row";
            document.getElementById("resultSpouseName").textContent =
              document.getElementById("spouseName").value || "-";
            document.getElementById("resultSpouseAge").textContent =
              document.getElementById("spouseAge").textContent || "-";
          } else {
            spouseInfoSection.style.display = "none";
          }

          // Handle dependents information
          const dependentsCount =
            parseInt(document.getElementById("dependents").value) || 0;
          const dependentsInfoSection = document.getElementById(
            "dependentsInfoSection"
          );
          const resultDependentsTable = document.getElementById(
            "resultDependentsTable"
          );

          if (dependentsCount > 0) {
            dependentsInfoSection.style.display = "table-row";
            resultDependentsTable.innerHTML = ""; // Clear existing rows

            for (let i = 1; i <= dependentsCount; i++) {
              const name =
                document.getElementById(`dependentName${i}`)?.value ||
                `Child ${i}`;
              const age =
                document.getElementById(`dependentAge${i}`)?.textContent || "-";

              const row = document.createElement("tr");
              row.innerHTML = `
                <td><strong>${name}:</strong></td>
                <td>${age} years</td>
              `;
              resultDependentsTable.appendChild(row);
            }
          } else {
            dependentsInfoSection.style.display = "none";
          }

          // Calculate Cash Flow Overview
          const userMonthlyIncome =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="monthly-income"]'
              )?.value
            ) || 0;
          const userMonthlyBusiness =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="monthly-business"]'
              )?.value
            ) || 0;
          const userMonthlyRental =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="monthly-rental"]'
              )?.value
            ) || 0;

          const spouseMonthlyIncome =
            parseFloat(
              document.querySelector(
                '.spouse-present-value[data-metric="monthly-income"]'
              )?.value
            ) || 0;
          const spouseMonthlyBusiness =
            parseFloat(
              document.querySelector(
                '.spouse-present-value[data-metric="monthly-business"]'
              )?.value
            ) || 0;
          const spouseMonthlyRental =
            parseFloat(
              document.querySelector(
                '.spouse-present-value[data-metric="monthly-rental"]'
              )?.value
            ) || 0;

          const totalMonthlyIncome =
            userMonthlyIncome +
            userMonthlyBusiness +
            userMonthlyRental +
            (maritalStatus === "Married"
              ? spouseMonthlyIncome +
                spouseMonthlyBusiness +
                spouseMonthlyRental
              : 0);

          const userMonthlyExpenses =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="monthly-expenses"]'
              )?.value
            ) || 0;
          const spouseMonthlyExpenses =
            parseFloat(
              document.querySelector(
                '.spouse-present-value[data-metric="monthly-expenses"]'
              )?.value
            ) || 0;
          const totalMonthlyExpenses =
            userMonthlyExpenses +
            (maritalStatus === "Married" ? spouseMonthlyExpenses : 0);

          const userMonthlyMortgage =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="monthly-mortgage"]'
              )?.value
            ) || 0;
          const spouseMonthlyMortgage =
            parseFloat(
              document.querySelector(
                '.spouse-present-value[data-metric="monthly-mortgage"]'
              )?.value
            ) || 0;
          const totalMonthlyMortgage =
            userMonthlyMortgage +
            (maritalStatus === "Married" ? spouseMonthlyMortgage : 0);

          // Update Cash Flow Overview section
          document.getElementById("resultMonthlyIncome").textContent =
            totalMonthlyIncome.toFixed(2);
          document.getElementById("resultMonthlyExpenses").textContent =
            totalMonthlyExpenses.toFixed(2);
          document.getElementById("resultMonthlyMortgage").textContent =
            totalMonthlyMortgage.toFixed(2);

          const totalExpensesWithMortgage =
            totalMonthlyExpenses + totalMonthlyMortgage;
          const cashFlowDifference =
            totalMonthlyIncome - totalExpensesWithMortgage;

          if (totalExpensesWithMortgage > totalMonthlyIncome) {
            document.getElementById("resultCashFlowStatus").textContent =
              "Monthly Shortfall";
            document.getElementById("resultCashFlowAmount").textContent =
              Math.abs(cashFlowDifference).toFixed(2);
            document.getElementById("resultCashFlowAmount").style.color =
              "#ff5555";
          } else {
            document.getElementById("resultCashFlowStatus").textContent =
              "Monthly Savings";
            document.getElementById("resultCashFlowAmount").textContent =
              cashFlowDifference.toFixed(2);
            document.getElementById("resultCashFlowAmount").style.color =
              "#4CAF50";
          }

          // Calculate Emergency Fund Overview
          const monthlyTotal = totalExpensesWithMortgage;
          const emergencyFund3 = monthlyTotal * 3;
          const emergencyFund6 = monthlyTotal * 6;

          // Get current emergency fund amount by summing up all liquid assets from step 4.3
          const userStocks =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="stocks"]'
              )?.value
            ) || 0;
          const userCDs =
            parseFloat(
              document.querySelector('.user-present-value[data-metric="cds"]')
                ?.value
            ) || 0;
          const userCash =
            parseFloat(
              document.querySelector('.user-present-value[data-metric="cash"]')
                ?.value
            ) || 0;

          const spouseStocks =
            maritalStatus === "Married"
              ? parseFloat(
                  document.querySelector(
                    '.spouse-present-value[data-metric="stocks"]'
                  )?.value
                ) || 0
              : 0;
          const spouseCDs =
            maritalStatus === "Married"
              ? parseFloat(
                  document.querySelector(
                    '.spouse-present-value[data-metric="cds"]'
                  )?.value
                ) || 0
              : 0;
          const spouseCash =
            maritalStatus === "Married"
              ? parseFloat(
                  document.querySelector(
                    '.spouse-present-value[data-metric="cash"]'
                  )?.value
                ) || 0
              : 0;

          const currentEmergencyFund =
            userStocks +
            userCDs +
            userCash +
            spouseStocks +
            spouseCDs +
            spouseCash;

          // Update Emergency Fund Overview section
          document.getElementById("resultEmergencyFund3").textContent =
            emergencyFund3.toFixed(2);
          document.getElementById("resultEmergencyFund6").textContent =
            emergencyFund6.toFixed(2);
          document.getElementById("resultCurrentEmergencyFund").textContent =
            currentEmergencyFund.toFixed(2);

          // Determine emergency fund status
          let emergencyFundStatus;
          let statusColor;
          if (currentEmergencyFund >= emergencyFund6) {
            emergencyFundStatus = "Excellent - Exceeds 6 months";
            statusColor = "#4CAF50"; // Green
          } else if (currentEmergencyFund >= emergencyFund3) {
            emergencyFundStatus = "Good - Meets 3-6 months";
            statusColor = "#bdb76b"; // Gold
          } else if (currentEmergencyFund >= monthlyTotal) {
            emergencyFundStatus = "Fair - Below 3 months";
            statusColor = "#FFA500"; // Orange
          } else {
            emergencyFundStatus = "Needs Attention - Below 1 month";
            statusColor = "#ff5555"; // Red
          }

          const statusElement = document.getElementById(
            "resultEmergencyFundStatus"
          );
          statusElement.textContent = emergencyFundStatus;
          statusElement.style.color = statusColor;

          // Calculate final totals
          calculateTotals();

          // Calculate Protection Overview
          const totalDebt =
            parseFloat(
              document.getElementById("resultTotalDebt").textContent
            ) || 0;
          const monthlyIncome = totalMonthlyIncome;
          const kidsEducation = Array.from(
            document.querySelectorAll('.goal-amount[data-metric^="education"]')
          ).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
          const mortgageDebt =
            parseFloat(
              document.querySelector('[data-metric="mortgage-debt"]')?.value
            ) || 0;

          // Calculate household coverage needed
          const householdCoverageNeeded =
            totalDebt + monthlyIncome * 12 * 10 + mortgageDebt + kidsEducation;

          // Get current life insurance coverage
          const lifeWorkCoverage =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="lifeWork"]'
              )?.value
            ) || 0;
          const lifeOutsideCoverage =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="lifeOutside"]'
              )?.value
            ) || 0;
          const disabilityCoverage =
            parseFloat(
              document.querySelector(
                '.user-present-value[data-metric="disability"]'
              )?.value
            ) || 0;
          const currentLifeInsurance =
            lifeWorkCoverage + lifeOutsideCoverage + disabilityCoverage;

          // Calculate coverage gap
          const coverageGap = householdCoverageNeeded - currentLifeInsurance;

          // Update household coverage section
          document.getElementById("resultHouseholdCoverage").textContent =
            householdCoverageNeeded.toFixed(2);
          document.getElementById("resultCurrentLifeInsurance").textContent =
            currentLifeInsurance.toFixed(2);

          const coverageGapElement =
            document.getElementById("resultCoverageGap");
          if (coverageGap <= 0) {
            coverageGapElement.textContent = "Recommended Coverage Achieved";
            coverageGapElement.style.color = "#4CAF50"; // Green color
          } else {
            coverageGapElement.textContent = coverageGap.toFixed(2);
            coverageGapElement.style.color = "#ff5555"; // Red color
          }

          // Handle spouse coverage if married
          if (maritalStatus === "Married") {
            document.getElementById("spouseCoverageSection").style.display =
              "table-row";

            // Calculate spouse coverage needed (monthly income * 12 * 10 or minimum $1000/month if no income)
            const spouseMonthlyTotal =
              spouseMonthlyIncome + spouseMonthlyBusiness + spouseMonthlyRental;
            const spouseCoverageNeeded =
              (spouseMonthlyTotal > 0 ? spouseMonthlyTotal : 1000) * 12 * 10;

            // Get spouse's current coverage including all insurance types
            const spouseLifeWorkCoverage =
              parseFloat(
                document.querySelector(
                  '.spouse-present-value[data-metric="lifeWork"]'
                )?.value
              ) || 0;
            const spouseLifeOutsideCoverage =
              parseFloat(
                document.querySelector(
                  '.spouse-present-value[data-metric="lifeOutside"]'
                )?.value
              ) || 0;
            const spouseDisabilityCoverage =
              parseFloat(
                document.querySelector(
                  '.spouse-present-value[data-metric="disability"]'
                )?.value
              ) || 0;
            const spouseCurrentCoverage =
              spouseLifeWorkCoverage +
              spouseLifeOutsideCoverage +
              spouseDisabilityCoverage;

            // Calculate spouse coverage gap
            const spouseCoverageGap =
              spouseCoverageNeeded - spouseCurrentCoverage;

            // Update spouse coverage section
            document.getElementById("resultSpouseCoverageNeeded").textContent =
              spouseCoverageNeeded.toFixed(2);
            document.getElementById("resultSpouseCurrentCoverage").textContent =
              spouseCurrentCoverage.toFixed(2);

            const spouseCoverageGapElement = document.getElementById(
              "resultSpouseCoverageGap"
            );
            if (spouseCoverageGap <= 0) {
              spouseCoverageGapElement.textContent =
                "Recommended Coverage Achieved";
              spouseCoverageGapElement.style.color = "#4CAF50"; // Green color
            } else {
              spouseCoverageGapElement.textContent =
                spouseCoverageGap.toFixed(2);
              spouseCoverageGapElement.style.color = "#ff5555"; // Red color
            }
          } else {
            document.getElementById("spouseCoverageSection").style.display =
              "none";
          }

          // Show results page
          showStep(6);
        } catch (error) {
          console.error("Error calculating results:", error);
          alert(
            "An error occurred while calculating results. Please check your inputs and try again."
          );
        }
      }

      // Add validation function
      function validateRequiredFields() {
        // Basic personal information validation
        const requiredFields = ["userName", "userDOB", "userRetirementAge"];

        for (const fieldId of requiredFields) {
          const field = document.getElementById(fieldId);
          if (!field || !field.value.trim()) {
            return false;
          }
        }

        // Validate age calculation
        const userAge = parseInt(
          document.getElementById("userAge").textContent
        );
        if (isNaN(userAge) || userAge <= 0) {
          return false;
        }

        return true;
      }

      function resetWizard() {
        // Force a complete page reload from the server (true parameter forces bypass of cache)
        location.reload(true);
      }

      // Initialize the wizard on page load
      document.addEventListener("DOMContentLoaded", () => {
        toggleSpouseSection();
        updateAllProjectedValues();
      });

      function generateCollegePlanningRows() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const collegeTableBody = document.querySelector("#collegePlanningBody");
        if (!collegeTableBody) return;

        collegeTableBody.innerHTML = "";

        for (let i = 1; i <= dependentsCount; i++) {
          const name =
            document.getElementById(`dependentName${i}`)?.value || `Child ${i}`;
          const row = document.createElement("tr");
          row.innerHTML = `
      <td class="dependent-label">${name}</td>
      <td><input type="number" class="present-value" data-metric="529-child${i}" data-child="${i}" step="0.01" oninput="updateCollegeProjectedValue(this)"></td>
      <td><input type="number" class="annual-contribution" data-metric="529-child${i}" data-child="${i}" step="0.01" oninput="updateCollegeProjectedValue(this)"></td>
      <td><input type="number" class="rate-of-return" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" value="1.58" oninput="updateCollegeProjectedValue(this)"></td>
      <td><span class="projected-value" data-metric="529-child${i}" data-child="${i}">0.00</span></td>
    `;
          collegeTableBody.appendChild(row);
        }
      }

      // Ensure the table rows update if dependent names change
      document
        .getElementById("dependentsSection")
        ?.addEventListener("input", function (e) {
          if (e.target && e.target.id.startsWith("dependentName")) {
            generateCollegePlanningRows();
          }
        });
    </script>
    <script>
      function renderCollege529Rows() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const tbody = document.getElementById("college529Body");
        tbody.innerHTML = "";
        for (let i = 1; i <= dependentsCount; i++) {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>529 Plan - Child ${i}</td>
      <td><input type="number" class="present-value" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" oninput="updateCollegeProjectedValue(this)"></td>
      <td><input type="number" class="annual-contribution" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" oninput="updateCollegeProjectedValue(this)"></td>
      <td><input type="number" class="rate-of-return" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" placeholder="1.58" oninput="updateCollegeProjectedValue(this)"></td>
      <td><span class="projected-value" data-metric="529-child${i}" data-child="${i}">0.00</span></td>
    `;
          tbody.appendChild(row);
        }
      }

      function updateCollegeProjectedValue(input) {
        const metric = input.getAttribute("data-metric");
        const child = input.getAttribute("data-child");
        const row = input.closest("tr");

        const presentValue =
          parseFloat(row.querySelector(".present-value")?.value) || 0;
        const contribution =
          parseFloat(row.querySelector(".annual-contribution")?.value) || 0;
        const rateInput =
          parseFloat(row.querySelector(".rate-of-return")?.value) || 4;
        const projectedSpan = row.querySelector(".projected-value");
        const dobInput = document.getElementById(`dependentDOB${child}`)?.value;

        let age = 0;
        if (dobInput) {
          const [month, year] = dobInput.split("/").map(Number);
          const currentDate = new Date();
          const birthDate = new Date(year, month - 1);
          age = currentDate.getFullYear() - birthDate.getFullYear();
          if (
            currentDate.getMonth() < birthDate.getMonth() ||
            (currentDate.getMonth() === birthDate.getMonth() &&
              currentDate.getDate() < birthDate.getDate())
          ) {
            age--;
          }
        }

        const yearsToCollege = Math.max(0, 18 - age);
        const rate = rateInput / 100;

        // Calculate projected value
        let projectedValue = presentValue;
        if (yearsToCollege > 0) {
          const futureValuePrincipal =
            presentValue * Math.pow(1 + rate, yearsToCollege);
          const futureValueContributions =
            (contribution * (Math.pow(1 + rate, yearsToCollege) - 1)) / rate;
          projectedValue = futureValuePrincipal + futureValueContributions;
        }

        // Update projected value display
        if (projectedSpan) {
          projectedSpan.textContent = projectedValue.toFixed(2);
        }

        // Store in financial data
        if (!financialData.assets.college) {
          financialData.assets.college = {};
        }

        financialData.assets.college[`child${child}`] = {
          presentValue: presentValue,
          annualContribution: contribution,
          rateOfReturn: rateInput,
          projectedValue: projectedValue,
          yearsToCollege: yearsToCollege,
        };

        // Save to localStorage
        saveFinancialData();

        // Update the overview
        setTimeout(updateCollegePlanningOverview, 100);
      }

      function updateCollegePlanningOverview() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const overviewDiv = document.getElementById("collegePlanningOverview");

        if (dependentsCount === 0) {
          overviewDiv.innerHTML =
            "<p>No dependents added for college planning.</p>";
          return;
        }

        let html =
          '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
        html += `
            <thead>
                <tr>
                    <th style="text-align: left;">Dependent</th>
                    <th style="text-align: center;">Years Until College</th>
                    <th style="text-align: right;">Goal Amount ($)</th>
                    <th style="text-align: right;">Current Savings ($)</th>
                    <th style="text-align: right;">Projected Amount ($)</th>
                    <th style="text-align: right;">Gap Amount ($)</th>
                </tr>
            </thead>
            <tbody>
        `;

        for (let i = 1; i <= dependentsCount; i++) {
          const name =
            document.getElementById(`dependentName${i}`)?.value || `Child ${i}`;
          const collegeData = financialData.assets.college[`child${i}`] || {};
          const goalAmount =
            parseFloat(
              document.querySelector(
                `.goal-amount[data-metric="college-child${i}"]`
              )?.value
            ) || 0;

          // Get Cash Value Life Insurance amount if it's designated for college and this is the first child
          let additionalCollegeFunds = 0;
          if (i === 1) {
            // Only for the first child
            const cashValuePurpose = document.querySelector(
              '.purpose[data-metric="cashValue"]'
            )?.value;
            if (cashValuePurpose === "college") {
              const userCashValue =
                parseFloat(
                  document.querySelector(
                    '.user-present-value[data-metric="cashValue"]'
                  )?.value
                ) || 0;
              const spouseCashValue =
                parseFloat(
                  document.querySelector(
                    '.spouse-present-value[data-metric="cashValue"]'
                  )?.value
                ) || 0;
              additionalCollegeFunds = userCashValue + spouseCashValue;
            }
          }

          const presentValue =
            (collegeData.presentValue || 0) + additionalCollegeFunds;
          const projectedValue =
            (collegeData.projectedValue || 0) + additionalCollegeFunds;
          const yearsUntilCollege = collegeData.yearsToCollege || 0;

          // Calculate gap
          const gap = goalAmount - projectedValue;
          const gapColor = gap > 0 ? "#ff5555" : "#4CAF50";

          html += `
                <tr>
                    <td style="text-align: left;">${name}</td>
                    <td style="text-align: center;">${yearsUntilCollege}</td>
                    <td style="text-align: right;">${goalAmount.toLocaleString(
                      "en-US",
                      { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                    )}</td>
                    <td style="text-align: right;">${presentValue.toLocaleString(
                      "en-US",
                      { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                    )}</td>
                    <td style="text-align: right;">${projectedValue.toLocaleString(
                      "en-US",
                      { minimumFractionDigits: 2, maximumFractionDigits: 2 }
                    )}</td>
                    <td style="text-align: right; color: ${gapColor};">${Math.abs(
            gap
          ).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })}</td>
                </tr>
            `;
        }

        html += "</tbody></table>";

        // Add summary section
        html += `
            <div style="margin-top: 15px; padding: 10px; background: #2a2a2a; border-radius: 4px;">
                <h4 style="margin-top: 0;">Summary Notes:</h4>
                <ul style="list-style-type: none; padding-left: 10px;">
                    <li> Goal amounts should be adjusted based on specific college choices and inflation</li>
                    <li> Consider additional funding sources (scholarships, grants, loans)</li>
                    <li> Review and adjust savings strategy annually</li>
                </ul>
            </div>
        `;

        overviewDiv.innerHTML = html;
      }

      // Add function to restore college planning values
      function restoreCollegePlanningValues() {
        if (!financialData.assets.college) return;

        Object.keys(financialData.assets.college).forEach((childKey) => {
          const childNum = childKey.replace("child", "");
          const data = financialData.assets.college[childKey];

          const row = document.querySelector(`tr[data-child="${childNum}"]`);
          if (row) {
            const presentValueInput = row.querySelector(".present-value");
            const contributionInput = row.querySelector(".annual-contribution");
            const rateInput = row.querySelector(".rate-of-return");
            const projectedSpan = row.querySelector(".projected-value");

            if (presentValueInput) presentValueInput.value = data.presentValue;
            if (contributionInput)
              contributionInput.value = data.annualContribution;
            if (rateInput) rateInput.value = data.rateOfReturn;
            if (projectedSpan)
              projectedSpan.textContent = data.projectedValue.toFixed(2);
          }
        });
      }

      // Update the college planning rows generation
      function renderCollegePlanningRows() {
        const count =
          parseInt(document.getElementById("dependents").value) || 0;
        const tbody = document.getElementById("collegePlanningBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        for (let i = 1; i <= count; i++) {
          const name =
            document.getElementById(`dependentName${i}`)?.value || `Child ${i}`;
          const yearsUntilCollege = calculateYearsUntilCollege(i);

          const tr = document.createElement("tr");
          tr.setAttribute("data-child", i);
          tr.innerHTML = `
            <td>${name}</td>
            <td style="text-align: center;">${yearsUntilCollege}</td>
            <td>
                <input type="number" class="present-value" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" oninput="updateCollegeProjectedValue(this)">
            </td>
            <td>
                <input type="number" class="annual-contribution" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" oninput="updateCollegeProjectedValue(this)">
            </td>
            <td>
                <input type="number" class="rate-of-return" data-metric="529-child${i}" data-child="${i}" min="0" step="0.01" value="4" oninput="updateCollegeProjectedValue(this)">
            </td>
            <td>
                <span class="projected-value" data-metric="529-child${i}" data-child="${i}">0.00</span>
            </td>
        `;
          tbody.appendChild(tr);
        }

        // Restore saved values after generating rows
        restoreCollegePlanningValues();
      }

      // Add restoration to navigation buttons
      document.addEventListener("DOMContentLoaded", function () {
        const subStepButtons = document.querySelectorAll(
          'button[onclick*="SubStep"]'
        );
        subStepButtons.forEach((button) => {
          const originalOnClick = button.onclick;
          button.onclick = function (e) {
            if (originalOnClick) originalOnClick.call(this, e);
            setTimeout(restoreCollegePlanningValues, 100); // Small delay to ensure DOM is ready
          };
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        function updateCollegeTable() {
          const tableBody = document.querySelector("#collegePlanningBody");
          tableBody.innerHTML = "";
          const dependentsCount =
            parseInt(document.getElementById("dependents").value) || 0;

          for (let i = 1; i <= dependentsCount; i++) {
            const name =
              document.getElementById(`dependentName${i}`)?.value ||
              `Child ${i}`;
            const row = document.createElement("tr");
            row.innerHTML = `
        <td>${name}</td>
        <td><input type="number" class="present-value" data-child="${i}" oninput="updateCollegeProjectedValue(${i})" /></td>
        <td><input type="number" class="annual-contribution" data-child="${i}" oninput="updateCollegeProjectedValue(${i})" /></td>
        <td><input type="number" class="rate-of-return" data-child="${i}" value="1.58" oninput="updateCollegeProjectedValue(${i})" /></td>
        <td><span class="projected-value" data-child="${i}">0.00</span></td>
      `;
            tableBody.appendChild(row);
          }
        }

        document
          .getElementById("dependents")
          .addEventListener("input", updateCollegeTable);
        document
          .querySelectorAll("[id^='dependentName']")
          .forEach((input) =>
            input.addEventListener("input", updateCollegeTable)
          );
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const retirementAge = parseInt(
          localStorage.getItem("retirementAge") || "65"
        );
        const rows = document.querySelectorAll("#step3_3 tbody tr");

        rows.forEach((row) => {
          const amountInput = row.querySelector("input");
          const retirementDropdown = row.querySelector(
            "select.retirement-until"
          );
          const projectedCell = row.querySelector("td:last-child");

          function calculate() {
            const monthlyAmount = parseFloat(amountInput.value) || 0;
            const untilAge = parseInt(retirementDropdown.value) || 85;
            const years = untilAge - retirementAge;
            const projected = monthlyAmount * 12 * years;
            projectedCell.textContent = projected.toLocaleString(undefined, {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          }

          amountInput.addEventListener("input", calculate);
          retirementDropdown.addEventListener("change", calculate);
        });
      });
    </script>
    <script>
      function updateRetirementProjectedValue() {
        const monthlyExpensesSpan = document.querySelector(
          '.projected-value[data-metric="monthly-expenses"]'
        );
        const retirementIncomeInput = document.querySelector(
          '.goal-amount[data-metric="retirement-income"]'
        );
        const projectedSpan = document.querySelector(
          '.projected-value[data-metric="retirement-income"]'
        );
        const planUntil =
          parseInt(document.getElementById("retirementPlanUntil").value) || 85;
        const retirementAge =
          parseInt(document.getElementById("userRetirementAge").value) || 65;
        const currentAge =
          parseInt(document.getElementById("userAge").textContent) || 0;

        if (monthlyExpensesSpan && retirementIncomeInput && projectedSpan) {
          // Keep the existing value if it exists and is valid
          const existingValue = parseFloat(retirementIncomeInput.value);
          const monthlyAmount =
            !isNaN(existingValue) && existingValue > 0
              ? existingValue
              : parseFloat(monthlyExpensesSpan.textContent) || 0;

          // Only update the input value if it's empty or invalid
          if (
            !retirementIncomeInput.value ||
            isNaN(parseFloat(retirementIncomeInput.value))
          ) {
            retirementIncomeInput.value = monthlyAmount.toFixed(2);
          }

          // Calculate years between retirement age and plan until age
          const yearsInRetirement = Math.max(0, planUntil - retirementAge);

          // Calculate total needed for retirement period
          const total = monthlyAmount * 12 * yearsInRetirement;
          projectedSpan.textContent = total.toFixed(2);

          // Update retirement age message if it exists
          const retirementAgeMessage = document.getElementById(
            "retirementAgeMessage"
          );
          if (retirementAgeMessage) {
            const yearsUntilRetirement = Math.max(
              0,
              retirementAge - currentAge
            );
            retirementAgeMessage.textContent = `Your retirement age is ${retirementAge}, remaining years till retirement: ${yearsUntilRetirement}`;
          }

          // Update financial data store
          if (financialData.goals && financialData.goals.retirement) {
            financialData.goals.retirement.monthlyIncome = monthlyAmount;
            financialData.goals.retirement.projectedAmount = total;
            financialData.goals.retirement.retirementAge = retirementAge;
            financialData.goals.retirement.planUntil = planUntil;
            saveFinancialData();
          }

          // Update all projected values that depend on retirement age
          document
            .querySelectorAll(
              ".rate-of-return, .user-present-value, .spouse-present-value"
            )
            .forEach((input) => {
              updateProjectedValue(input, "projected");
            });
        }
      }

      // Add event listeners for retirement age and plan until changes
      document.addEventListener("DOMContentLoaded", function () {
        const userRetirementAgeInput =
          document.getElementById("userRetirementAge");
        const planUntilSelect = document.getElementById("retirementPlanUntil");

        if (userRetirementAgeInput) {
          userRetirementAgeInput.addEventListener("input", function () {
            // Store the retirement age in localStorage
            localStorage.setItem("retirementAge", this.value);
            updateRetirementProjectedValue();
          });
        }

        if (planUntilSelect) {
          planUntilSelect.addEventListener("change", function () {
            updateRetirementProjectedValue();
          });
        }

        // Initial update
        updateRetirementProjectedValue();
      });

      // Update getYearsToRetirement to use the stored retirement age
      function getYearsToRetirement() {
        const userAge = calculateAge("user");
        const userRetirementAge =
          parseInt(localStorage.getItem("retirementAge")) ||
          parseInt(document.getElementById("userRetirementAge").value) ||
          65;

        const userYearsToRetirement = Math.max(0, userRetirementAge - userAge);

        // Show error message if years is 0
        const retirementError = document.getElementById("retirementError");
        if (retirementError) {
          if (userYearsToRetirement === 0 && currentStep === 2) {
            retirementError.style.display = "block";
          } else {
            retirementError.style.display = "none";
          }
        }

        return userYearsToRetirement;
      }
    </script>
    <script>
      function updateLongTermCareAmount() {
        const maritalStatus = document.getElementById("maritalStatus").value;
        const span = document.getElementById("longTermCareAmount");
        if (span) {
          if (maritalStatus === "Married") {
            span.textContent = "$480,000";
          } else {
            span.textContent = "$240,000";
          }
        }
      }

      // Call this function on page load and whenever marital status changes
      document.addEventListener("DOMContentLoaded", updateLongTermCareAmount);
      document
        .getElementById("maritalStatus")
        .addEventListener("change", updateLongTermCareAmount);
    </script>
    <script>
      function updateHealthCareOutOfPocketAmount() {
        const maritalStatus = document.getElementById("maritalStatus").value;
        const span = document.getElementById("healthCareOutOfPocketAmount");
        if (span) {
          if (maritalStatus === "Married") {
            span.textContent = "$320,000";
          } else {
            span.textContent = "$160,000";
          }
        }
      }

      document.addEventListener(
        "DOMContentLoaded",
        updateHealthCareOutOfPocketAmount
      );
      document
        .getElementById("maritalStatus")
        .addEventListener("change", updateHealthCareOutOfPocketAmount);
    </script>
    <script>
      const dependentNames = [];

      function updateDependentsSection() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const dependentsSection = document.getElementById("dependentsSection");
        dependentsSection.innerHTML = "";
        dependentNames.length = 0; // Clear previous entries

        if (dependentsCount > 0) {
          let html =
            "<h3>Dependents Information</h3><table><tr><th>Dependent</th><th>Name</th><th>Date of Birth (mm/yyyy)</th><th>Current Age</th></tr>";
          for (let i = 1; i <= dependentsCount; i++) {
            html += `
          <tr>
            <td>Dependent ${i}</td>
            <td><input type="text" id="dependentName${i}" placeholder="Enter name" oninput="saveDependentName(${i}, this.value)"></td>
            <td><input type="text" id="dependentDOB${i}" placeholder="mm/yyyy" oninput="calculateDependentAge(${i})"></td>
            <td><span id="dependentAge${i}" class="calculated-age">0</span></td>
          </tr>
        `;
            dependentNames.push(""); // Reserve space
          }
          html += "</table>";
          dependentsSection.innerHTML = html;
        }
      }

      function saveDependentName(index, name) {
        dependentNames[index - 1] = name;
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Initial setup
        updateDependentsSection();

        // Add event listener for dependents count changes
        document
          .getElementById("dependents")
          .addEventListener("input", function () {
            updateDependentsSection();
            updateDependentTables();
          });
      });

      function updateDependentTables() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const collegePlanningTableBody = document.getElementById(
          "collegePlanningTableBody"
        );
        const weddingPlanningTableBody = document.getElementById(
          "weddingPlanningTableBody"
        );

        if (!collegePlanningTableBody || !weddingPlanningTableBody) {
          console.error("Table bodies not found");
          return;
        }

        // Clear existing rows
        collegePlanningTableBody.innerHTML = "";
        weddingPlanningTableBody.innerHTML = "";

        // Add new rows for each dependent
        for (let i = 1; i <= dependentsCount; i++) {
          const name =
            document.getElementById(`dependentName${i}`)?.value || `Child ${i}`;

          // Add row to college planning table
          const collegeRow = document.createElement("tr");
          collegeRow.innerHTML = `
            <td>${name}</td>
            <td>
              <input
                class="goal-amount"
                data-metric="college-child${i}"
                min="0"
                oninput="updateGoalProjectedValue(this)"
                placeholder="Enter goal amount"
                step="0.01"
                style="width: 200px"
                type="number"
              />
            </td>
          `;
          collegePlanningTableBody.appendChild(collegeRow);

          // Add row to wedding planning table
          const weddingRow = document.createElement("tr");
          weddingRow.innerHTML = `
            <td>${name}</td>
            <td>
              <input
                class="goal-amount"
                data-metric="wedding-child${i}"
                min="0"
                oninput="updateGoalProjectedValue(this)"
                placeholder="Enter goal amount"
                step="0.01"
                style="width: 200px"
                type="number"
              />
            </td>
          `;
          weddingPlanningTableBody.appendChild(weddingRow);
        }
      }

      function updateDependentsSection() {
        const dependentsCount =
          parseInt(document.getElementById("dependents").value) || 0;
        const dependentsSection = document.getElementById("dependentsSection");

        if (!dependentsSection) {
          console.error("Dependents section not found");
          return;
        }

        dependentsSection.innerHTML = "";

        if (dependentsCount > 0) {
          let html =
            "<h3>Dependents Information</h3><table><tr><th>Dependent</th><th>Name</th><th>Date of Birth (mm/yyyy)</th><th>Current Age</th></tr>";
          for (let i = 1; i <= dependentsCount; i++) {
            html += `
              <tr>
                <td>Dependent ${i}</td>
                <td><input type="text" id="dependentName${i}" placeholder="Enter name" oninput="handleDependentNameChange(${i})"></td>
                <td><input type="text" id="dependentDOB${i}" placeholder="mm/yyyy" oninput="calculateDependentAge(${i})"></td>
                <td><span id="dependentAge${i}" class="calculated-age">0</span></td>
              </tr>
            `;
          }
          html += "</table>";
          dependentsSection.innerHTML = html;
        }

        // Update the college and wedding planning tables
        updateDependentTables();
      }

      function handleDependentNameChange(index) {
        // Update tables when a dependent's name changes
        updateDependentTables();
      }

      // Add this to your existing event listeners
      document.addEventListener("DOMContentLoaded", function () {
        const dependentsInput = document.getElementById("dependents");
        if (dependentsInput) {
          dependentsInput.addEventListener("input", function () {
            updateDependentsSection();
            updateDependentTables();
          });
        }
      });
    </script>
    <script>
      // Function to restore and manage retirement values
      function restoreRetirementValues() {
        // Get the input elements
        const monthlyInput = document.querySelector(
          '.goal-amount[data-metric="retirement-income"]'
        );
        const planUntilSelect = document.getElementById("retirementPlanUntil");

        // Get saved values from localStorage
        const savedAmount = localStorage.getItem("retirement-monthly-amount");
        const savedPlanUntil = localStorage.getItem("retirement-plan-until");

        // Restore saved values if they exist
        if (savedAmount && monthlyInput) {
          monthlyInput.value = savedAmount;
        }
        if (savedPlanUntil && planUntilSelect) {
          planUntilSelect.value = savedPlanUntil;
        }

        // Update projected values
        if (monthlyInput) {
          updateProjectedValue(monthlyInput, "projected");
        }
      }
      // Set up event listeners when document loads
      document.addEventListener("DOMContentLoaded", function () {
        // Initial restoration of values
        restoreRetirementValues();

        // Get input elements
        const monthlyInput = document.querySelector(
          '.goal-amount[data-metric="retirement-income"]'
        );
        const planUntilSelect = document.getElementById("retirementPlanUntil");

        // Add listener for monthly input changes
        if (monthlyInput) {
          monthlyInput.addEventListener("input", function () {
            // Save to localStorage
            localStorage.setItem("retirement-monthly-amount", this.value);
            // Update projections
            updateProjectedValue(this, "projected");
          });
        }

        // Add listener for retirement age selection changes
        if (planUntilSelect) {
          planUntilSelect.addEventListener("change", function () {
            // Save to localStorage
            localStorage.setItem("retirement-plan-until", this.value);
            // Update projections for monthly input
            const monthlyInput = document.querySelector(
              '.goal-amount[data-metric="retirement-income"]'
            );
            if (monthlyInput) {
              updateProjectedValue(monthlyInput, "projected");
            }
          });
        }
      });

      // Add restoration to navigation buttons
      document.querySelectorAll("button").forEach((button) => {
        if (
          button.onclick?.toString().includes("nextSubStep") ||
          button.onclick?.toString().includes("prevSubStep")
        ) {
          button.addEventListener("click", restoreRetirementValues);
        }
      });
    </script>
    <script>
      function updateCashFlowProjectedValue(input) {
        const metric = input.getAttribute("data-metric");
        const row = input.closest("tr");
        const userPresentValueInput = row.querySelector(".user-present-value");
        const spousePresentValueInput = row.querySelector(
          ".spouse-present-value"
        );
        const inflationRateInput = row.querySelector(".inflation-rate");
        const projectedSpan = row.querySelector(".projected-value");
        const maritalStatus = document.getElementById("maritalStatus").value;
        const years = getYearsToRetirement();

        if (!projectedSpan) return;

        // Only use the actual input value, ignore placeholder if the field is empty
        const userPresentValue = userPresentValueInput?.value
          ? parseFloat(userPresentValueInput.value)
          : 0;
        const spousePresentValue =
          maritalStatus === "Married" && spousePresentValueInput?.value
            ? parseFloat(spousePresentValueInput.value)
            : 0;

        // For inflation rate, use placeholder if no value is entered
        const inflationRate = inflationRateInput?.value
          ? parseFloat(inflationRateInput.value)
          : parseFloat(inflationRateInput?.placeholder) || 0;

        const rate = inflationRate / 100;
        const totalPresentValue = userPresentValue + spousePresentValue;
        const projectedValue = totalPresentValue * Math.pow(1 + rate, years);

        projectedSpan.textContent = projectedValue.toFixed(2);

        // Update financial data store
        updateFinancialDataStore(input);

        // If this is the monthly expenses row, update the retirement income goal
        if (metric === "monthly-expenses") {
          setTimeout(() => {
            updateRetirementProjectedValue();
          }, 0);
        }
      }

      // Add event listeners for both input and change events on monthly expenses fields
      document.addEventListener("DOMContentLoaded", function () {
        // First update the cash flow values
        document.querySelectorAll("#cashFlowTable tr").forEach((row) => {
          const input = row.querySelector(".user-present-value");
          if (input) {
            updateCashFlowProjectedValue(input);
          }
        });

        // Add event listeners for monthly expenses fields
        const monthlyExpensesInputs = document.querySelectorAll(
          '[data-metric="monthly-expenses"]'
        );
        monthlyExpensesInputs.forEach((input) => {
          input.addEventListener("input", function () {
            updateCashFlowProjectedValue(this);
          });
          input.addEventListener("change", function () {
            updateCashFlowProjectedValue(this);
          });
        });
      });

      function updateRetirementProjectedValue() {
        const monthlyExpensesSpan = document.querySelector(
          '.projected-value[data-metric="monthly-expenses"]'
        );
        const retirementIncomeInput = document.querySelector(
          '.goal-amount[data-metric="retirement-income"]'
        );
        const projectedSpan = document.querySelector(
          '.projected-value[data-metric="retirement-income"]'
        );
        const planUntil =
          parseInt(document.getElementById("retirementPlanUntil").value) || 85;
        const retirementAge =
          parseInt(document.getElementById("userRetirementAge").value) || 65;

        if (monthlyExpensesSpan && retirementIncomeInput && projectedSpan) {
          const monthlyAmount =
            parseFloat(monthlyExpensesSpan.textContent) || 0;

          // Update the retirement income input and trigger its events
          retirementIncomeInput.value = monthlyAmount.toFixed(2);
          retirementIncomeInput.dispatchEvent(
            new Event("input", { bubbles: true })
          );
          retirementIncomeInput.dispatchEvent(
            new Event("change", { bubbles: true })
          );

          const years = Math.max(0, planUntil - retirementAge);
          const total = monthlyAmount * 12 * years;
          projectedSpan.textContent = total.toFixed(2);

          // Update financial data store
          if (financialData.goals && financialData.goals.retirement) {
            financialData.goals.retirement.monthlyIncome = monthlyAmount;
            financialData.goals.retirement.projectedAmount = total;
            saveFinancialData();
          }
        }
      }

      // Update the step numbers in the wizard tabs
      document.addEventListener("DOMContentLoaded", function () {
        const wizardTabs = document.querySelector(".wizard-tabs");
        if (wizardTabs) {
          const tabs = wizardTabs.querySelectorAll("a");
          tabs.forEach((tab, index) => {
            tab.setAttribute(
              "onclick",
              `navigateToStep(${index + 1}); return false;`
            );
          });
        }
      });
    </script>
    <script>
      // Add updateDebtAmount function
      function updateDebtAmount(input) {
        const metric = input.getAttribute("data-metric");
        const amount = parseFloat(input.value) || 0;

        // Store the debt amount in localStorage for persistence
        localStorage.setItem(`debt-${metric}`, amount);

        // Update debt overview
        updateDebtOverview();
      }

      // Handle monthly payment updates
      function updateMonthlyPayment(input) {
        const metric = input.getAttribute("data-metric");
        const amount = parseFloat(input.value) || 0;

        // Store the monthly payment in localStorage
        localStorage.setItem(`monthly-${metric}`, amount);

        // Update any related calculations
        updateDebtOverview();
      }

      // Add event listeners for monthly payment inputs when the page loads
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".monthly-payment").forEach((input) => {
          const metric = input.getAttribute("data-metric");
          const savedValue = localStorage.getItem(`monthly-${metric}`);
          if (savedValue) {
            input.value = savedValue;
          }
          input.addEventListener("input", function () {
            updateMonthlyPayment(this);
          });
        });
      });

      function updateDebtOverview() {
        // Get all debt amounts and monthly payments
        const creditCardDebt =
          parseFloat(
            document.querySelector('[data-metric="credit-card-debt"]')?.value
          ) || 0;
        const creditCardPayment =
          parseFloat(
            document.querySelector('[data-metric="credit-card-payment"]')?.value
          ) || 0;
        const carLoanDebt =
          parseFloat(
            document.querySelector('[data-metric="car-loan-debt"]')?.value
          ) || 0;
        const mortgageDebt =
          parseFloat(
            document.querySelector('[data-metric="mortgage-debt"]')?.value
          ) || 0;
        const studentLoanDebt =
          parseFloat(
            document.querySelector('[data-metric="student-loan-debt"]')?.value
          ) || 0;
        const otherDebt =
          parseFloat(
            document.querySelector('[data-metric="other-debt"]')?.value
          ) || 0;

        // Calculate total debt
        // Calculate total monthly payments
        const mortgagePayment =
          parseFloat(
            document.querySelector('[data-metric="mortgage-payment"]')?.value
          ) || 0;
        const carLoanPayment =
          parseFloat(
            document.querySelector('[data-metric="car-loan-payment"]')?.value
          ) || 0;
        const studentLoanPayment =
          parseFloat(
            document.querySelector('[data-metric="student-loan-payment"]')
              ?.value
          ) || 0;
        const otherDebtPayment =
          parseFloat(
            document.querySelector('[data-metric="other-debt-payment"]')?.value
          ) || 0;

        const totalDebt =
          mortgageDebt +
          creditCardDebt +
          carLoanDebt +
          studentLoanDebt +
          otherDebt;
        const totalMonthlyPayments =
          mortgagePayment +
          creditCardPayment +
          carLoanPayment +
          studentLoanPayment +
          otherDebtPayment;

        // Update the total debt and monthly payments display
        document.getElementById("totalDebtAmount").textContent =
          totalDebt.toFixed(2);

        // Update the monthly payment display if it exists
        const totalMonthlyElement = document.getElementById(
          "totalMonthlyPayment"
        );
        if (totalMonthlyElement) {
          totalMonthlyElement.textContent = totalMonthlyPayments.toFixed(2);
        }
        document.getElementById("resultTotalDebt").textContent =
          totalDebt.toFixed(2);

        // Determine priority focus and recommendations
        let priorityFocus = "";
        let recommendations = [];

        if (creditCardDebt > 0 && carLoanDebt > 0) {
          priorityFocus =
            '<span class="priority-high">Credit Card and Car Loan Debt</span>';
          recommendations.push(
            "Focus on paying off both credit card and car loan debt due to high interest rates."
          );
        } else if (creditCardDebt > 0) {
          priorityFocus = '<span class="priority-high">Credit Card Debt</span>';
          recommendations.push(
            "Prioritize paying off credit card debt due to typically high interest rates."
          );
        } else if (carLoanDebt > 0) {
          priorityFocus = '<span class="priority-medium">Car Loan Debt</span>';
          recommendations.push("Focus on paying off car loan debt.");
        }

        if (creditCardDebt > 10000) {
          recommendations.push(
            "Consider debt consolidation or refinancing options for credit card debt."
          );
        }

        if (mortgageDebt > 0) {
          recommendations.push(
            "Review mortgage terms for potential refinancing opportunities."
          );
        }

        // Update displays
        document.getElementById("debtPriorityFocus").innerHTML =
          priorityFocus || "No high-priority debt identified";
        document.getElementById("resultDebtAction").innerHTML =
          priorityFocus || "No high-priority debt identified";

        const recommendationsHtml =
          recommendations.length > 0
            ? '<ul style="margin: 5px 0; padding-left: 20px;"><li>' +
              recommendations.join("</li><li>") +
              "</li></ul>"
            : "<p>No specific recommendations at this time.</p>";

        document.getElementById("debtRecommendations").innerHTML =
          recommendationsHtml;
        document.getElementById("resultDebtRecommendations").innerHTML =
          recommendationsHtml;
      }

      // Call updateDebtOverview when page loads
      document.addEventListener("DOMContentLoaded", updateDebtOverview);
    </script>
    <!-- Add Financial Data Store -->
    <script>
      // Central Data Store
      const financialData = {
        assets: {
          retirement: {
            "401k": {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            rollover: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            traditional: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            roth: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            pension: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            ssaPia: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
          },
          realEstate: {
            primaryHome: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              mortgageBalance: 0,
            },
            rentals: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              mortgageBalance: 0,
            },
            land: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              mortgageBalance: 0,
            },
            inheritance: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              mortgageBalance: 0,
            },
          },
          investments: {
            stocks: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            business: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            alternatives: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            cds: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
            cash: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
          },
          insurance: {
            lifeWork: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
            },
            lifeOutside: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
            },
            cashValue: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
              purpose: "",
            },
            disability: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
            },
            longTermCare: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
            },
            hsa: {
              userPresentValue: 0,
              spousePresentValue: 0,
              projectedValue: 0,
              userAnnualContribution: 0,
              spouseAnnualContribution: 0,
            },
          },
          foreignAssets: {
            realEstateForeign: { presentValue: 0, projectedValue: 0 },
            nonRealEstateForeign: { presentValue: 0, projectedValue: 0 },
          },
        },
        totals: {
          userPresentValue: 0,
          spousePresentValue: 0,
          projectedValue: 0,
          userAnnualContribution: 0,
          spouseAnnualContribution: 0,
          goalAmount: 0,
          goalProjected: 0,
        },
        goals: {
          college: {},
          wedding: {},
          retirement: {
            monthlyIncome: 0,
            projectedAmount: 0,
            planUntil: 85,
          },
          healthcare: {
            outOfPocket: 160000,
            longTermCare: 240000,
          },
          lifeGoals: {
            travel: { amount: 0 },
            vacationHome: { amount: 0 },
            charity: { amount: 0 },
            other: { amount: 0 },
          },
          legacy: {
            kidsFund: { amount: 0 },
            legacyAssets: { amount: 0 },
            familySupport: { amount: 0 },
          },
        },
      };

      // Helper Functions
      function getCategoryFromMetric(metric) {
        const metricMap = {
          // Retirement
          "401k": "retirement",
          rollover: "retirement",
          traditional: "retirement",
          roth: "retirement",
          pension: "retirement",

          // Real Estate
          primaryHome: "realEstate",
          rentals: "realEstate",
          land: "realEstate",
          inheritance: "realEstate",

          // Investments
          stocks: "investments",
          business: "investments",
          alternatives: "investments",
          cds: "investments",
          cash: "investments",

          // Foreign Assets
          realEstateForeign: "foreignAssets",
          nonRealEstateForeign: "foreignAssets",

          // Insurance
          lifeWork: "insurance",
          lifeOutside: "insurance",
          cashValue: "insurance",
          disability: "insurance",
          longTermCare: "insurance",
          hsa: "insurance",
        };

        return metricMap[metric] || "other";
      }

      function getSubcategoryFromMetric(metric) {
        return metric;
      }

      function getAnnualContribution(input) {
        const row = input.closest("tr");
        const maritalStatus = document.getElementById("maritalStatus").value;
        const userContributionInput = row.querySelector(
          ".user-annual-contribution"
        );
        const spouseContributionInput = row.querySelector(
          ".spouse-annual-contribution"
        );

        const userContribution = parseFloat(userContributionInput?.value) || 0;
        const spouseContribution =
          maritalStatus === "Married"
            ? parseFloat(spouseContributionInput?.value) || 0
            : 0;

        return userContribution + spouseContribution;
      }

      function updateFinancialDataStore(input) {
        const metric = input.getAttribute("data-metric");
        const category = getCategoryFromMetric(metric);
        const subcategory = getSubcategoryFromMetric(metric);
        const maritalStatus = document.getElementById("maritalStatus").value;

        if (!financialData.assets[category]) {
          console.warn(
            `Category ${category} not found in financial data store`
          );
          return;
        }

        if (!financialData.assets[category][subcategory]) {
          console.warn(`Subcategory ${subcategory} not found in ${category}`);
          return;
        }

        const row = input.closest("tr");
        const userPresentValueInput = row.querySelector(".user-present-value");
        const spousePresentValueInput = row.querySelector(
          ".spouse-present-value"
        );
        const userContributionInput = row.querySelector(
          ".user-annual-contribution"
        );
        const spouseContributionInput = row.querySelector(
          ".spouse-annual-contribution"
        );
        const purposeSelect = row.querySelector(".purpose");
        const projectedSpan =
          row.querySelector(".projected-value") ||
          row.querySelector(".future-value");

        // Handle Cash Value Life Insurance purpose changes
        if (metric === "cashValue" && input.classList.contains("purpose")) {
          const purpose = input.value;
          const totalPresentValue =
            parseFloat(userPresentValueInput?.value) || 0;

          // Handle the present value distribution based on purpose
          if (purpose === "emergency") {
            // For emergency fund: add present value to the current emergency fund
            const emergencyFundInput = document.querySelector(
              '.goal-amount[data-metric="emergency-fund"]'
            );
            if (emergencyFundInput) {
              const currentValue = parseFloat(emergencyFundInput.value) || 0;
              emergencyFundInput.value = (
                currentValue + totalPresentValue
              ).toFixed(2);
              emergencyFundInput.dispatchEvent(new Event("input"));
            }
          } else if (purpose === "college") {
            // For college fund: add present value to the first kid in college planning results
            const collegeResultsTable = document.getElementById(
              "collegeResultsTable"
            );
            if (collegeResultsTable) {
              const firstKidInput = collegeResultsTable.querySelector(
                '.goal-amount[data-metric="college-1"]'
              );
              if (firstKidInput) {
                const currentValue = parseFloat(firstKidInput.value) || 0;
                firstKidInput.value = (
                  currentValue + totalPresentValue
                ).toFixed(2);
                firstKidInput.dispatchEvent(new Event("input"));
              }
            }
          } else if (purpose === "retirement") {
            // For retirement payout: Add as a new row with specific details
            const retirementTable = document.getElementById(
              "retirementResultsTable"
            );
            if (retirementTable) {
              // Remove existing cash value payout row if it exists
              const existingRow = Array.from(
                retirementTable.querySelectorAll("tr")
              ).find(
                (row) =>
                  row.cells[0]?.textContent ===
                  "PRODUCT - Cash Value payout from Whole life"
              );
              if (existingRow) {
                existingRow.remove();
              }

              // Create new row for Cash Value payout
              const newRow = document.createElement("tr");
              const projectedAmount = totalPresentValue * 0.04;
              newRow.innerHTML = `
                <td>PRODUCT - Cash Value payout from Whole life</td>
                <td>Non Guaranteed</td>
                <td>Non Taxable</td>
                <td>${projectedAmount.toFixed(2)}</td>
              `;
              retirementTable.querySelector("tbody").appendChild(newRow);

              // Update financial data store for retirement
              if (!financialData.goals.retirement.cashValuePayout) {
                financialData.goals.retirement.cashValuePayout = {
                  product: "Cash Value payout from Whole life",
                  incomeType: "Non Guaranteed",
                  taxStatus: "Non Taxable",
                  projectedAmount: projectedAmount,
                };
              }
            }
          } else if (purpose === "longterm") {
            // For long term care: add present value to the Required projected Long Term care
            const longTermCareInput = document.querySelector(
              '.goal-amount[data-metric="longterm-care"]'
            );
            if (longTermCareInput) {
              const currentValue = parseFloat(longTermCareInput.value) || 0;
              longTermCareInput.value = (
                currentValue + totalPresentValue
              ).toFixed(2);
              longTermCareInput.dispatchEvent(new Event("input"));
            }
          } else if (purpose === "legacy") {
            // For legacy overview: create a new row in legacy results called Projected Non-Real estate investment
            const legacyGoalsTable =
              document.getElementById("legacyGoalsTable");
            if (legacyGoalsTable) {
              // Remove existing non-real estate investment row if it exists
              const existingRow = Array.from(
                legacyGoalsTable.querySelectorAll("tr")
              ).find(
                (row) =>
                  row.cells[0]?.textContent ===
                  "Projected Non-Real estate investment"
              );
              if (existingRow) {
                existingRow.remove();
              }

              // Create new row for Non-Real estate investment
              const newRow = document.createElement("tr");
              newRow.innerHTML = `
                <td>Projected Non-Real estate investment</td>
                <td>${totalPresentValue.toFixed(2)}</td>
              `;
              legacyGoalsTable.querySelector("tbody").appendChild(newRow);

              // Update financial data store for legacy
              if (!financialData.goals.legacy) {
                financialData.goals.legacy = {};
              }
              financialData.goals.legacy.nonRealEstateInvestment =
                totalPresentValue;
            }
          }
        }

        // Get values for financial data store update
        const userPresentValue = parseFloat(userPresentValueInput?.value) || 0;
        const spousePresentValue =
          maritalStatus === "Married"
            ? parseFloat(spousePresentValueInput?.value) || 0
            : 0;
        const userAnnualContribution =
          parseFloat(userContributionInput?.value) || 0;
        const spouseAnnualContribution =
          maritalStatus === "Married"
            ? parseFloat(spouseContributionInput?.value) || 0
            : 0;
        const purpose = purposeSelect?.value || "";
        const projectedValue = projectedSpan
          ? parseFloat(projectedSpan.textContent) || 0
          : userPresentValue + spousePresentValue;

        // Special handling for insurance items that don't have projected values
        if (
          category === "insurance" &&
          ["lifeWork", "lifeOutside", "disability", "longTermCare"].includes(
            subcategory
          )
        ) {
          financialData.assets[category][subcategory] = {
            userPresentValue: userPresentValue,
            spousePresentValue: spousePresentValue,
            projectedValue: userPresentValue + spousePresentValue,
          };
        } else if (category === "insurance" && subcategory === "cashValue") {
          financialData.assets[category][subcategory] = {
            userPresentValue: userPresentValue,
            spousePresentValue: spousePresentValue,
            projectedValue: projectedValue,
            userAnnualContribution: userAnnualContribution,
            spouseAnnualContribution: spouseAnnualContribution,
            purpose: purpose,
          };
        } else {
          financialData.assets[category][subcategory] = {
            userPresentValue: userPresentValue,
            spousePresentValue: spousePresentValue,
            projectedValue: projectedValue,
            userAnnualContribution: userAnnualContribution,
            spouseAnnualContribution: spouseAnnualContribution,
          };
        }

        // If it's a real estate asset, add mortgage balance
        if (category === "realEstate") {
          const mortgageInput = row.querySelector(".mortgage-balance");
          if (mortgageInput) {
            financialData.assets[category][subcategory].mortgageBalance =
              parseFloat(mortgageInput.value) || 0;
          }
        }

        calculateTotals();
        saveFinancialData();
      }

      function calculateTotals() {
        const totals = {
          userPresentValue: 0,
          spousePresentValue: 0,
          projectedValue: 0,
          userAnnualContribution: 0,
          spouseAnnualContribution: 0,
          goalAmount: 0,
          goalProjected: 0,
        };

        // Calculate asset totals - ONLY from the assets section
        const assetCategories = [
          "retirement",
          "realEstate",
          "investments",
          "foreignAssets",
          "insurance",
        ];
        assetCategories.forEach((category) => {
          Object.keys(financialData.assets[category]).forEach((subcategory) => {
            const asset = financialData.assets[category][subcategory];
            if (asset) {
              totals.userPresentValue += asset.userPresentValue || 0;
              totals.spousePresentValue += asset.spousePresentValue || 0;
              totals.projectedValue += asset.projectedValue || 0;
              totals.userAnnualContribution +=
                asset.userAnnualContribution || 0;
              totals.spouseAnnualContribution +=
                asset.spouseAnnualContribution || 0;
            }
          });
        });

        // Calculate goal totals
        Object.keys(financialData.goals).forEach((category) => {
          if (category === "retirement") {
            totals.goalAmount +=
              financialData.goals.retirement.monthlyIncome * 12;
            totals.goalProjected +=
              financialData.goals.retirement.projectedAmount;
          } else if (category === "healthcare") {
            totals.goalAmount += financialData.goals.healthcare.outOfPocket;
            totals.goalAmount += financialData.goals.healthcare.longTermCare;
          } else {
            Object.values(financialData.goals[category]).forEach((goal) => {
              totals.goalAmount += goal.amount || 0;
            });
          }
        });

        // Update data store totals
        financialData.totals = totals;
      }

      function updateTotalsDisplay() {
        const maritalStatus = document.getElementById("maritalStatus").value;
        const totalPresent =
          maritalStatus === "Married"
            ? financialData.totals.userPresentValue +
              financialData.totals.spousePresentValue
            : financialData.totals.userPresentValue;

        document.getElementById("totalPresent").textContent =
          new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(totalPresent);

        document.getElementById("totalProjected").textContent =
          new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(financialData.totals.projectedValue);

        document.getElementById("totalGoalAmount").textContent =
          new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(financialData.totals.goalAmount);

        document.getElementById("totalGoalProjected").textContent =
          new Intl.NumberFormat("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }).format(financialData.totals.goalProjected);
      }

      function saveFinancialData() {
        localStorage.setItem("financialData", JSON.stringify(financialData));
      }

      function loadFinancialData() {
        const saved = localStorage.getItem("financialData");
        if (saved) {
          Object.assign(financialData, JSON.parse(saved));
          updateAllUIValues();
        }
      }

      function updateAllUIValues() {
        // Update all input fields and projected values based on stored data
        Object.keys(financialData.assets).forEach((category) => {
          Object.keys(financialData.assets[category]).forEach((subcategory) => {
            const asset = financialData.assets[category][subcategory];
            const inputs = document.querySelectorAll(
              `[data-metric="${subcategory}"]`
            );
            inputs.forEach((input) => {
              if (input.classList.contains("present-value")) {
                input.value = asset.presentValue;
              } else if (input.classList.contains("projected-value")) {
                input.textContent = asset.projectedValue.toFixed(2);
              } else if (input.classList.contains("annual-contribution")) {
                input.value = asset.annualContribution;
              } else if (input.classList.contains("purpose")) {
                input.value = asset.purpose || "";
              }
            });
          });
        });

        updateTotalsDisplay();
      }

      // Add event listeners for real-time updates
      document.addEventListener("input", function (e) {
        if (
          e.target.matches(
            ".present-value, .annual-contribution, .rate-of-return, .mortgage-balance"
          )
        ) {
          updateFinancialDataStore(e.target);
        }
      });

      // Load saved data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadFinancialData();
      });
    </script>
    <script>
      function showRetirementPlanning() {
        // Calculate retirement planning values
        calculateRetirementPlanning();
        // Show retirement planning step
        showStep(7);
      }

      function calculateRetirementPlanning() {
        // Get the required monthly income from retirement goals
        const requiredMonthlyIncome =
          parseFloat(
            document.querySelector(
              '.goal-amount[data-metric="retirement-income"]'
            )?.value
          ) || 0;

        // Calculate 401k projected amount (4% annual withdrawal rate, divided by 12 for monthly)
        const projected401k =
          parseFloat(
            document.querySelector('.projected-value[data-metric="401k"]')
              ?.textContent
          ) || 0;
        const monthly401k = (projected401k * 0.04) / 12; // Convert annual 4% to monthly
        document.getElementById("projected401k").textContent =
          monthly401k.toFixed(2);

        // Calculate IRA projected amount
        const projectedIRA =
          parseFloat(
            document.querySelector(
              '.projected-value[data-metric="traditional"]'
            )?.textContent
          ) || 0;
        const monthlyIRA = (projectedIRA * 0.04) / 12; // Convert annual 4% to monthly
        document.getElementById("projectedIRA").textContent =
          monthlyIRA.toFixed(2);

        // Calculate Roth IRA projected amount
        const projectedRothIRA =
          parseFloat(
            document.querySelector('.projected-value[data-metric="roth"]')
              ?.textContent
          ) || 0;
        const monthlyRothIRA = (projectedRothIRA * 0.04) / 12; // Convert annual 4% to monthly
        document.getElementById("projectedRothIRA").textContent =
          monthlyRothIRA.toFixed(2);

        // Calculate Annuity projected amount ($3,500 annual per $100k)
        const annuityValue =
          parseFloat(
            document.querySelector('.projected-value[data-metric="annuity"]')
              ?.textContent
          ) || 0;
        const monthlyAnnuity = ((annuityValue / 100000) * 3500) / 12; // Convert to monthly
        document.getElementById("projectedAnnuity").textContent =
          monthlyAnnuity.toFixed(2);

        // SSA is already monthly ($30,000 annual / 12)
        const monthlySSA = 2500; // $30,000 / 12
        document.getElementById("projectedSSA").textContent =
          monthlySSA.toFixed(2); // Show monthly amount instead of annual

        // Calculate Rental Income (80% of projected value for maintenance costs)
        const rentalIncome =
          parseFloat(
            document.querySelector('.projected-value[data-metric="rental"]')
              ?.textContent
          ) || 0;
        const monthlyRental = (rentalIncome * 0.8) / 12; // Convert to monthly after maintenance
        document.getElementById("projectedRental").textContent =
          monthlyRental.toFixed(2);

        // Calculate Business Revenue (monthly)
        const businessRevenue =
          parseFloat(
            document.querySelector('.projected-value[data-metric="business"]')
              ?.textContent
          ) || 0;
        const monthlyBusiness = businessRevenue / 12;
        document.getElementById("projectedBusiness").textContent =
          monthlyBusiness.toFixed(2);

        // Calculate total projected monthly income
        const totalMonthly =
          monthly401k +
          monthlyIRA +
          monthlyRothIRA +
          monthlyAnnuity +
          monthlySSA +
          monthlyRental +
          monthlyBusiness;
        document.getElementById("projectedTotal").textContent =
          totalMonthly.toFixed(2);

        // Update GAP Analysis
        const gapAnalysisDiv = document.getElementById("gapAnalysis");
        if (requiredMonthlyIncome > totalMonthly) {
          const shortfall = requiredMonthlyIncome - totalMonthly;
          gapAnalysisDiv.innerHTML = `
                <p style="color: #ff5555;">Required Monthly Income > Projected Payouts Amount:</p>
                <ul style="list-style-type: none; padding-left: 20px;">
                    <li> Difference Amount is a shortfall of $${shortfall.toFixed(
                      2
                    )}</li>
                    <li> Additional savings needed to adjust tax payments per Tax rate at retirement age</li>
                </ul>
            `;
        } else {
          const surplus = totalMonthly - requiredMonthlyIncome;
          gapAnalysisDiv.innerHTML = `
                <p style="color: #4CAF50;">Projected Payouts Amount > Required Monthly Income:</p>
                <ul style="list-style-type: none; padding-left: 20px;">
                    <li> Difference Amount is a surplus of $${surplus.toFixed(
                      2
                    )}</li>
                    <li> Surplus savings might be adjusted towards tax payments per Tax rate at retirement age</li>
                </ul>
            `;
        }
      }

      function showHealthCareAndLegacyOverview() {
        // Calculate health care and legacy values
        calculateHealthCareAndLegacyOverview();
        // Show health care and legacy overview step
        showStep(8);
      }

      function calculateHealthCareAndLegacyOverview() {
        // Get marital status
        const maritalStatus = document.getElementById("maritalStatus").value;

        // Calculate Long Term Care values
        const requiredLongTermCare =
          maritalStatus === "Married" ? 480000 : 240000;
        const currentLongTermCare =
          parseFloat(
            document.querySelector(
              '.user-present-value[data-metric="longTermCare"]'
            )?.value || 0
          ) +
          (maritalStatus === "Married"
            ? parseFloat(
                document.querySelector(
                  '.spouse-present-value[data-metric="longTermCare"]'
                )?.value || 0
              )
            : 0);
        const longTermCareGap = requiredLongTermCare - currentLongTermCare;

        // Update Long Term Care display
        document.getElementById("requiredLongTermCare").textContent =
          requiredLongTermCare.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        const longTermCareGapElement =
          document.getElementById("longTermCareGap");
        longTermCareGapElement.textContent = Math.abs(
          longTermCareGap
        ).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        longTermCareGapElement.style.color =
          longTermCareGap > 0 ? "#ff5555" : "#4CAF50";

        // Calculate Health Care Expenses values
        const requiredHealthExpenses =
          maritalStatus === "Married" ? 320000 : 160000;
        const projectedHSA = parseFloat(
          document.querySelector('.projected-value[data-metric="hsa"]')
            ?.textContent || 0
        );
        const healthExpensesGap = requiredHealthExpenses - projectedHSA;

        // Update Health Care Expenses display
        document.getElementById("requiredHealthExpenses").textContent =
          requiredHealthExpenses.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        const healthExpensesGapElement =
          document.getElementById("healthExpensesGap");
        healthExpensesGapElement.textContent = Math.abs(
          healthExpensesGap
        ).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        healthExpensesGapElement.style.color =
          healthExpensesGap > 0 ? "#ff5555" : "#4CAF50";

        // Calculate Legacy values
        const legacyGoalAmount = parseFloat(
          document.querySelector('.goal-amount[data-metric="legacyAssets"]')
            ?.value || 0
        );

        // Calculate projected real estate value (sum of all real estate investments)
        const realEstateMetrics = [
          "primaryHome",
          "rentals",
          "land",
          "inheritance",
          "realEstateForeign",
        ];
        let projectedRealEstate = 0;
        realEstateMetrics.forEach((metric) => {
          projectedRealEstate += parseFloat(
            document.querySelector(`.projected-value[data-metric="${metric}"]`)
              ?.textContent || 0
          );
        });

        // Get non-real estate investment value from financial data store
        const nonRealEstateInvestment =
          financialData.goals.legacy?.nonRealEstateInvestment || 0;

        // Calculate total projected assets (real estate + non-real estate investments)
        const totalProjectedAssets =
          projectedRealEstate + nonRealEstateInvestment;

        // Calculate the gap between goal amount and total projected assets
        const legacyGap = legacyGoalAmount - totalProjectedAssets;

        // Update Legacy display
        document.getElementById("legacyGoalAmount").textContent =
          legacyGoalAmount.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("projectedRealEstate").textContent =
          projectedRealEstate.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("projectedNonRealEstate").textContent =
          nonRealEstateInvestment.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        const legacyGapElement = document.getElementById("legacyGap");
        legacyGapElement.textContent = Math.abs(legacyGap).toLocaleString(
          "en-US",
          {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          }
        );
        legacyGapElement.style.color = legacyGap > 0 ? "#ff5555" : "#4CAF50";
      }
    </script>
    <script>
      function calculateAndShowResults() {
        // First try to calculate results
        try {
          // Validate required fields first
          if (!validateRequiredFields()) {
            alert("Please fill in all required fields before viewing results.");
            return;
          }

          // If validation passes, calculate results and show step 6
          calculateResults();
        } catch (error) {
          console.error("Error calculating results:", error);
          alert(
            "Please complete all required sections before viewing results."
          );
          return;
        }
      }
    </script>
    <script>
      function updateSSAPiaValue(input) {
        const metric = input.getAttribute("data-metric");
        const row = input.closest("tr");
        const userPresentValueInput = row.querySelector(".user-present-value");
        const spousePresentValueInput = row.querySelector(
          ".spouse-present-value"
        );
        const projectedSpan = row.querySelector(".projected-value");
        const maritalStatus = document.getElementById("maritalStatus").value;

        if (!projectedSpan) return;

        const userPresentValue = parseFloat(userPresentValueInput?.value) || 0;
        const spousePresentValue =
          maritalStatus === "Married"
            ? parseFloat(spousePresentValueInput?.value) || 0
            : 0;
        const totalPresentValue = userPresentValue + spousePresentValue;

        // Set projected value equal to present value
        projectedSpan.textContent = totalPresentValue.toFixed(2);

        // Update financial data store
        if (!financialData.assets.retirement) {
          console.warn("Retirement category not found in financial data store");
          return;
        }

        if (!financialData.assets.retirement.ssaPia) {
          console.warn("SSA PIA subcategory not found in retirement");
          return;
        }

        financialData.assets.retirement.ssaPia = {
          userPresentValue: userPresentValue,
          spousePresentValue: spousePresentValue,
          projectedValue: totalPresentValue,
          userAnnualContribution: 0,
          spouseAnnualContribution: 0,
        };

        // Save to local storage
        saveFinancialData();

        // Update totals display
        updateTotalsDisplay();
      }
    </script>
    <script>
      function generatePDF() {
        // List of result step IDs
        const stepIds = ["step6", "step7", "step8"];
        // Save original class states
        const originalStates = {};
        stepIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            originalStates[id] = el.className;
            el.classList.add("active");
            el.style.display = "block";
          }
        });

        // Create a container for all result steps
        const resultsContainer = document.createElement("div");
        stepIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            const clone = el.cloneNode(true);
            // Remove navigation/buttons from PDF
            const buttons = clone.querySelectorAll(".buttons");
            buttons.forEach((btn) => btn.remove());
            resultsContainer.appendChild(clone);
          }
        });
        resultsContainer.style.padding = "20px";
        resultsContainer.style.backgroundColor = "#fff";
        resultsContainer.style.color = "#000";
        const opt = {
          margin: 10,
          filename:
            "financial_analysis_" +
            new Date().toISOString().slice(0, 10) +
            ".pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        };
        html2pdf()
          .set(opt)
          .from(resultsContainer)
          .save()
          .then(() => {
            resultsContainer.remove();
            // Restore original states
            stepIds.forEach((id) => {
              const el = document.getElementById(id);
              if (el && originalStates[id] !== undefined) {
                el.className = originalStates[id];
                if (!el.classList.contains("active")) {
                  el.style.display = "none";
                } else {
                  el.style.display = "";
                }
              }
            });
          });
      }
    </script>
    <script>
      async function generatePDF() {
        const stepIds = ["step6", "step7", "step8"];
        const canvases = [];

        for (const id of stepIds) {
          const el = document.getElementById(id);
          if (!el) {
            console.warn("Missing element:", id);
            continue;
          }

          const prevDisplay = el.style.display;
          el.style.display = "block";
          await new Promise((r) => setTimeout(r, 300));

          try {
            const canvas = await html2canvas(el, { scale: 2, useCORS: true });
            canvases.push(canvas);
          } catch (err) {
            console.error("html2canvas error for", id, err);
          }

          el.style.display = prevDisplay;
        }

        if (canvases.length === 0) {
          console.warn("No canvases to render.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "pt", "a4");
        const pageHeight = pdf.internal.pageSize.height;
        const pageWidth = pdf.internal.pageSize.width;

        canvases.forEach((canvas, index) => {
          const imgData = canvas.toDataURL("image/jpeg", 1.0);
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pageWidth;
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

          if (index > 0) pdf.addPage();
          pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);
        });

        pdf.save("Complete_Financial_Report.pdf");
      }
    </script>
  <!-- Alternative Investments Modal -->
<div class="modal" id="altInvModal" style="display:none;">
  <div class="modal-content" style="max-width:900px;">
    <span class="close" onclick="closeAltInvModal()">&times;</span>
    <h2>Alternative Investments</h2>
    <table id="altInvTable" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>Metric</th>
          <th>User Present Value</th>
          <th>Spouse Present Value</th>
          <th>User Annual Contribution</th>
          <th>Spouse Annual Contribution</th>
          <th>Rate of return</th>
          <th>Projected value</th>
        </tr>
      </thead>
      <tbody id="altInvTableBody">
        <tr>
          <td><input type="text" class="metric" placeholder="[user input]" /></td>
          <td><input type="number" class="user-present-value" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
          <td><input type="number" class="spouse-present-value" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
          <td><input type="number" class="user-annual-contribution" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
          <td><input type="number" class="spouse-annual-contribution" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
          <td><input type="number" class="rate-of-return" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
          <td><span class="projected-value">0.00</span></td>
        </tr>
      </tbody>
    </table>
    <button onclick="addAltInvRow()" style="margin-top:10px;">Add another metric</button>
    <p style="font-size:0.9em; margin-top:10px;">*add another metric button* (if the user presses this then make sure to add another row to the table)</p>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.7);
}
.modal-content {
  background-color: #000;
  margin: 5% auto;
  padding: 36px 32px 28px 32px;
  border: 1px solid #bdb76b;
  border-radius: 12px;
  color: #fff;
  box-shadow: 0 8px 32px 0 rgba(0,0,0,0.45);
}
.modal-content table {
  background: #111;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 24px;
}
.modal-content table th, .modal-content table td {
  border: 1px solid #bdb76b;
  padding: 12px 10px;
  background: #111;
}
.modal-content table th {
  background: #222;
  color: #e4d96f;
  font-size: 1.08em;
  font-weight: bold;
}
.modal-content input[type="number"], .modal-content input[type="text"] {
  width: 100%;
  background: #191919;
  color: #fff;
  border: 1px solid #bdb76b;
  border-radius: 4px;
  padding: 7px 6px;
  margin: 0 0 2px 0;
  font-size: 1em;
}
.modal-content .close {
  float: right;
  font-size: 2em;
  cursor: pointer;
  color: #bdb76b;
  margin-top: -12px;
}
.modal-content button {
  margin-top: 10px;
  margin-bottom: 8px;
  padding: 10px 20px;
  background: #bdb76b;
  color: #222;
  border: none;
  border-radius: 6px;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.modal-content button:hover {
  background: #e4d96f;
}

</style>
<script>
function openAltInvModal(event) {
  event.preventDefault();
  document.getElementById('altInvModal').style.display = 'block';
}
function closeAltInvModal() {
  document.getElementById('altInvModal').style.display = 'none';
  // Sum all values from the popup rows and update the main table
  let userPVSum = 0, spousePVSum = 0, userACSum = 0, spouseACSum = 0, projSum = 0;
  const rows = document.querySelectorAll('#altInvTableBody tr');
  rows.forEach(row => {
    userPVSum += parseFloat(row.querySelector('.user-present-value')?.value || 0);
    spousePVSum += parseFloat(row.querySelector('.spouse-present-value')?.value || 0);
    userACSum += parseFloat(row.querySelector('.user-annual-contribution')?.value || 0);
    spouseACSum += parseFloat(row.querySelector('.spouse-annual-contribution')?.value || 0);
    projSum += parseFloat((row.querySelector('.projected-value')?.textContent || '0').replace(/,/g, ''));
  });
  // Update the main table's Alternative Investments row
  // Find the correct row by looking for the data-metric="alternatives" inputs
  document.querySelector('input.user-present-value[data-metric="alternatives"]').value = userPVSum ? userPVSum.toFixed(2) : '';
  document.querySelector('input.spouse-present-value[data-metric="alternatives"]').value = spousePVSum ? spousePVSum.toFixed(2) : '';
  document.querySelector('input.user-annual-contribution[data-metric="alternatives"]').value = userACSum ? userACSum.toFixed(2) : '';
  document.querySelector('input.spouse-annual-contribution[data-metric="alternatives"]').value = spouseACSum ? spouseACSum.toFixed(2) : '';
  document.querySelector('span.projected-value[data-metric="alternatives"]').textContent = projSum.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  // Trigger recalculation if needed
  if (typeof updateProjectedValue === 'function') {
    // Update all projected values in case the summary affects other calculations
    updateProjectedValue(document.querySelector('input.user-present-value[data-metric="alternatives"]'), 'projected');
  }
}

window.onclick = function(event) {
  const modal = document.getElementById('altInvModal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
};
function addAltInvRow() {
  const tbody = document.getElementById('altInvTableBody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" class="metric" placeholder="[user input]" /></td>
    <td><input type="number" class="user-present-value" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
    <td><input type="number" class="spouse-present-value" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
    <td><input type="number" class="user-annual-contribution" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
    <td><input type="number" class="spouse-annual-contribution" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
    <td><input type="number" class="rate-of-return" min="0" step="0.01" oninput="updateAltInvProjectedValue(this)" /></td>
    <td><span class="projected-value">0.00</span></td>
  `;
  tbody.appendChild(row);
}
function updateAltInvProjectedValue(input) {
  const row = input.closest('tr');
  const userPV = parseFloat(row.querySelector('.user-present-value').value) || 0;
  const spousePV = parseFloat(row.querySelector('.spouse-present-value').value) || 0;
  const userAC = parseFloat(row.querySelector('.user-annual-contribution').value) || 0;
  const spouseAC = parseFloat(row.querySelector('.spouse-annual-contribution').value) || 0;
  const rate = parseFloat(row.querySelector('.rate-of-return').value) || 0;
  const years = typeof getYearsToRetirement === 'function' ? getYearsToRetirement() : 20;
  // Compound growth formula: FV = PV*(1+r)^n + PMT*(((1+r)^n-1)/r)
  const r = rate/100;
  const n = years;
  let FV = 0;
  if (r > 0) {
    FV = (userPV + spousePV) * Math.pow(1+r, n) + (userAC + spouseAC) * ((Math.pow(1+r, n)-1)/r);
  } else {
    FV = (userPV + spousePV) + (userAC + spouseAC) * n;
  }
  row.querySelector('.projected-value').textContent = FV.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}
</script>

</body>
</html>
